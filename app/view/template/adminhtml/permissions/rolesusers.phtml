<style type="text/css">
#roles-list LI {
	margin-left:40px;
}

SPAN.link {
	cursor:pointer;
}

#roles-list UL UL {
	display:none;
}
</style>
<script type="text/javascript">
var role = function () {
	return {
		fold: function (el) {
			var el = el.parentNode.getElementsByTagName('ul')[0];
			with (el.style) {
				display = (display == "block") ? "none" : "block";
			}
			
			var id = el.parentNode.getElementsByTagName('span')[0].id.substr(1); //temporary RoleId = DOM.id
			$('role_pid_value').value = id;
		},
		
		deleteFromRole: function (el) {
			var uid = el.id.substr(1);
			var roleId = el.parentNode.parentNode.parentNode.getElementsByTagName('span')[0].id.substr(1);
			
			var req = new Ajax.Request('/permissions/index/deleteuserfromrole', {
				method:'post',
				parameters: {
					role_id: roleId,
					user_id: uid
				},
				onSuccess: function(transport){
					eval('var json = ' + transport.responseText);
					if (json.error) {
						alert(json.error_message);
						return false;
					}
					
					el.parentNode.parentNode.removeChild(el.parentNode);
				},
				onFailure: function() { 
					alert('Something went wrong...');
				}
			});
			
		},
		
		addUser2Role: function () {
			var uid = $('users').value;
			var roleId = $('role_pid_value').value;
			
			var req = new Ajax.Request('/permissions/index/adduser2role', {
				method:'post',
				parameters: {
					role_id: roleId,
					user_id: uid
				},
				onSuccess: function(transport){
					eval('var json = ' + transport.responseText);
					if (json.error) {
						alert(json.error_message);
						return false;
					}
					
					var newU = document.createElement('li');
					newU.innerHTML = $('users').options[$('users').selectedIndex].text + " ";
					var newCb = document.createElement('span');
					newCb.className = 'link';
					newCb.id = uid;
					newCb.onclick = function () {
						role.deleteFromRole(newCb);
					}
					newCb.innerHTML = "-";
					newU.appendChild(newCb);
					
					$('r'+roleId).parentNode.getElementsByTagName('ul')[0].appendChild(newU);
				},
				onFailure: function() { 
					alert('Something went wrong...');
				}
			});	
		}
	}
}();
</script>
<div id="roles-list">
	<ul>
		<?php foreach ($roles as $role) { ?>
		<li>
			<span id="r<?=$role->getRole_id();?>" class="link" onclick="role.fold(this);"><?=$role->getRole_name();?></span>
			<ul>
			<?php foreach ($role->getUsers() as $user) { ?>
				<li><?=$user->getFirstname();?> <span id="u<?=$user->getUser_id();?>" class="link" onclick="role.deleteFromRole(this)">-</span></li>
			<?php } ?>
			</ul>
		</li>
		<?php } ?>
	</ul>
</div>

<input type="text" name="role_pid_value" id="role_pid_value" />
<select id="users">
	<?php foreach ($users as $user) { ?>
	<option value="<?=$user->getUser_id();?>"><?=$user->getFirstname();?></option>
	<?php } ?>
</select>
<input type="button" value="Add" onclick="role.addUser2Role()" />