<?php
/**
 * {license_notice}
 *
 * @category    Mage
 * @package     Mage_Launcher
 * @copyright   {copyright}
 * @license     {license_link}
 */

/** @var $this Mage_Launcher_Block_Adminhtml_Storelauncher_Shipping_Drawer_OriginAddress */

$address = $this->getAddress();
?>
<form id="shipping-origin-address" class="shipping-origin-address" action="" method="post">
    <div id="shipping-origin-address-view"
         class="shipping-origin-address-view"
         style="<?php if ($address['show_form']): ?>display:none;<?php endif; ?>">
        <h2 class="title" id="shipping-origin-address-view-title"><?php echo $this->helper('Mage_Launcher_Helper_Data')->__('Shipping Address'); ?></h2>
        <ul class="shipping-origin-address-data">
            <?php foreach ($address['data'] as $addressValue): ?>
            <?php if (!empty($addressValue)) :?>
                <li><?php echo $this->escapeHtml($addressValue); ?></li>
                <?php endif; ?>
            <?php endforeach; ?>
        </ul>
        <div class="actions">
            <button type="button" class="action-edit-address" id="action-origin-address-edit">
                <span><?php echo $this->helper('Mage_Launcher_Helper_Data')->__('Edit'); ?></span>
            </button>
        </div>
    </div>
    <div id="shipping-origin-address-form"
         class="shipping-origin-address-form"
         style="<?php if (!$address['show_form']): ?>display:none;<?php endif; ?>">
        <h2 class="title"><?php echo $this->helper('Mage_Launcher_Helper_Data')->__('Edit Shipping Address'); ?></h2>
        <?php echo $this->getFormHtml(); ?>
        <?php echo $this->getChildHtml('form_after'); ?>
        <div class="actions">
            <button type="button"
                    id="action-origin-address-save"
                    class="action-save primary"
                    data-save-url="<?php echo $this->getUrl('*/storelauncher_shipping_drawer/saveOriginAddress') ?>">
                <span><?php echo $this->helper('Mage_Launcher_Helper_Data')->__('Save'); ?></span>
            </button>
            <button type="button" id="action-origin-address-cancel" class="action-cancel">
                <span><?php echo $this->helper('Mage_Launcher_Helper_Data')->__('Cancel'); ?></span>
            </button>
        </div>
    </div>
</form>
<script id="addressTemplate" type="text/x-jquery-tmpl">
    <ul class="shipping-origin-address-data">
        <li>${street_line1}</li>
        <li>${street_line2}</li>
        <li>${city}</li>
        <li>${postcode}</li>
        <li>${country}</li>
        <li>${region}</li>
    </ul>
</script>
<script type="text/javascript">
    (function($) {
        var originAddressView = $('#shipping-origin-address-view'),
            originAddressForm = $('#shipping-origin-address-form'),
            editOriginAddress = $('#action-origin-address-edit'),
            saveOriginAddress = $('#action-origin-address-save'),
            cancelOriginAddress = $('#action-origin-address-cancel'),
            messagePlaceholder = $('#shipping-origin-address-view-title'),
            insertValidationMessage = function(messageText, messageType) {
                $('<div class="message-validation ' + messageType + '">' + messageText + '</div>')
                        .insertAfter(messagePlaceholder);
                delay && clearTimeout(delay);
                var delay = setTimeout(function() {
                    $('.message-validation').slideUp(400);
                }, 3000);
            },
            originAddressEditSwitchOff = function() {
                originAddressForm.hide();
                originAddressView.show();
            },
            originAddressEditSwitchOn = function() {
                originAddressView.hide();
                originAddressForm.show();
            };
        saveOriginAddress
            .on('click.OriginAddressSave', function(event) {
                event.preventDefault();
                var drawerForm = $('#shipping-origin-address').validation();
                originAddressForm.addClass('loading');
                if (!drawerForm.valid()) {
                    return;
                }

                $.ajax({
                    type: 'POST',
                    data: drawerForm.serializeArray(),
                    dataType: 'json',
                    showLoader: true,
                    context: originAddressForm,
                    url: $(this).attr('data-save-url')
                }).success(function(result, status) {
                        originAddressForm.removeClass('loading');
                        if (result && result.error_message) {
                            insertValidationMessage(result.error_message, 'error');
                        } else {
                            var address = [{
                                street_line1: $('#street_line1').val(),
                                street_line2: $('#street_line2').val(),
                                city: $('#city').val(),
                                postcode: $('#postcode').val(),
                                country: $('#country_id option:selected').text(),
                                region: $('#region_id option:selected').text()
                            }];
                            originAddressView
                                .find('.shipping-origin-address-data')
                                .html($("#addressTemplate")
                                .tmpl(address));

                            originAddressEditSwitchOff();
                            insertValidationMessage(result.message, 'success');
                        }
                    });
            });
        cancelOriginAddress
            .on('click.OriginAddressCancel', function(event) {
                event.preventDefault();
                originAddressEditSwitchOff();
            });
        editOriginAddress
            .on('click.OriginAddressEdit', function(event) {
                event.preventDefault();
                originAddressEditSwitchOn();
            });
    })(jQuery);
</script>