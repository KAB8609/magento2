<?php
/**
 * {license_notice}
 *
 * @category    Mage
 * @package     Mage_Launcher
 * @copyright   {copyright}
 * @license     {license_link}
 */

/** @var $this Mage_Launcher_Block_Adminhtml_Storelauncher_Design_Drawer */
?>
<form action="" id="drawer-form" method="post">
<div class="themes-list-wrapper">
<?php echo Mage::helper('Mage_Launcher_Helper_Data')->__('First choose a theme, then customize it for your business.') ?>

<ul class="themes-list">
    <?php foreach ($this->getThemesBlocks() as $theme):?>
        <?php echo $theme->toHtml() ?>
    <?php endforeach; ?>
</ul>

</div>

<div class="theme-page hidden">
    <input type="hidden" name="groups[design][theme][fields][theme_id][value]" id="theme-id" value="<?php echo $this->getCurrentThemeId(); ?>">
    <h2><?php echo $this->__('Great job! You\'ve chosen your store theme.'); ?></h2>
    <dl class="theme-selected-thumbnail">
        <dt>
            <?php echo $this->__('Your Store Theme'); ?> <a href="#" class="button btn-edit edit-theme" id="edit-theme"><?php echo $this->__('Back to Theme Gallery'); ?></a>
        </dt>
        <dd>
            <img src="<?php echo $this->getCurrentTheme()->getThemeImage()->getPreviewImageUrl() ?>" id="theme-image">
        </dd>
    </dl>
    <dl class="theme-selected-info">
        <dt><?php echo $this->__('Store Name'); ?></dt>
        <dd class="theme-selected-name">
            <div id="field-store-name-1" >
                <input type="text" id="store-name-1" name="store_information" value="<?php echo $this->getConfigValue('general/store_information/name'); ?>" class="input-text">
            </div>
            <div class="logo-uploaded-preview">
                <div class="current-logo current-logo-bg-1">
                    <div class="current-logo-inner">
                        <img alt="<?php echo $this->__('My Store Name'); ?>" src="<?php echo $this->getLogoUrl(); ?>"/>
                    </div>
                    <input type="hidden" id="design_header_logo_src" name="logo_src"/>
                </div>
                <div class="logo-background-switcher">
                    <span><?php echo $this->__('Logo Preview Options'); ?></span>
                    <ul>
                        <li class="logo-bg-1 active"></li>
                        <li class="logo-bg-2"></li>
                        <li class="logo-bg-3"></li>
                        <li class="logo-bg-4"></li>
                    </ul>
                </div>
            </div>
            <div class="file-upload">
                <div class="file-upload-drop-zone" style="border:1px solid black;"><?php echo $this->__('click or drag and drop to upload logo'); ?></div>
                <input type="file" id="design_header_logo_upload" name="logo_upload" class="input-file-upload" data-url="<?php echo $this->getUrl('*/storelauncher_design_drawer/uploadLogo'); ?>"/>
            </div>
        </dd>
    </dl>
</div>
</form>

<?php echo $this->getChildHtml('store_design.widget'); ?>
<script type="text/javascript">
    (function($) {
        var dropPlaceholder = $('.file-upload-drop-zone');
        dropPlaceholder.on('click.uploadFile',function(e) {
            $(this).next().trigger(e);
        });
        $('#design_header_logo_upload').fileupload({
            dataType: 'json',
            formData: {
                isAjax: 'true',
                form_key: FORM_KEY
            },
            sequentialUploads: false,
            dropZone: dropPlaceholder,
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
            done: function(e, data) {
                if (data.result.success == true) {
                    showLogoUploadMessage();
                    showUploadedImage(data.result.url);
                    $('#design_header_logo_src').val(data.result.file)
                } else {
                    showLogoUploadMessage(data.result.error);
                }
            },
            fail: function(e, data) {
                showLogoUploadMessage('<?php echo Mage::helper('Mage_Launcher_Helper_Data')->__('There was an error processing your request.'); ?>');
            },
            add: function(e, data) {
                $('#load-logo-errors').addClass('hidden');
                $(this).fileupload('process', data).done(function () {
                    data.submit();
                });
            }
        });
        $('logo-uploaded-preview').addClass('hidden');

        var showLogoUploadMessage = function(message) {
            var messageContainer = $('#logo-upload-errors');
            if (message) {
                alert(message);
                messageContainer
                    .text(message)
                    .removeClass('hidden');
            } else {
                messageContainer
                    .addClass('hidden');
            }
        },
        showUploadedImage = function(url) {
            $('.logo-uploaded-preview').removeClass('hidden');
            $('.current-logo-inner').find('img').attr('src', url);
        };

        $(document).ready(function() {
            'use strict';
            var currentThemeId = $('#theme-id').val();
            $('#drawer')
                .drawerPages()
                .drawerPages('headerButtonCreate', {
                    name: 'skip',
                    id: 'button_skip',
                    title: '<?php echo Mage::helper('Mage_Launcher_Helper_Data')->__('Skip this step'); ?>',
                    click: function() {
                        $('#drawer').drawerPages('drawerPageSwitch', 'theme-page');
                    },
                    afterShow: function() {
                        if (!currentThemeId) {
                            $(this).addClass('hidden');
                        }
                    }
                })
                .drawerPages('drawerPageAdd', {
                    name: 'themes-list',
                    page: '.themes-list-wrapper',
                    buttons: ['skip', 'close']
                })
                .drawerPages('drawerPageAdd', {
                    name: 'theme-page',
                    page: '.theme-page',
                    buttons: ['save', 'close']
                })
                .drawerPages('drawerPageSwitch', currentThemeId ? 'theme-page' : 'themes-list')
            ;
            $('.edit-theme')
                .on('click', function() {
                    $('#drawer').drawerPages('drawerPageSwitch', 'themes-list');
                    return false;
                });
            $('.btn-theme-choose')
                .on('click', function(event) {
                    event.preventDefault();
                    $('#drawer').drawerPages('drawerPageSwitch', 'theme-page');
                    $('#theme-image').attr('src' , $(this).attr('data-theme-img-src'));
                    $('#theme-id').val($(this).attr('data-theme-id'));
                    return false;
                });
        });
    })(jQuery);
</script>
