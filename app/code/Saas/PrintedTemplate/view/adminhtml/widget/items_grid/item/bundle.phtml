<?php
/**
 * {license_notice}
 *
 * @category    Saas
 * @package     Saas_PrintedTemplate
 * @copyright   {copyright}
 * @license     {license_link}
 */
?>

<?php
/**
 * @var Saas_PrintedTemplate_Block_Widget_Item_Renderer_Bundle $this
 * @todo re-factor this template
 */
?>
<?php
    $baseItem = $this->getItem();
    $groupedChildItems = $this->getChildren();
    $nameColumnExists = false;
    foreach ($this->getColumns() as $column) {
        if ($column->getProperty() == 'name') {
            $nameColumnExists = true;
            break;
        }
    }
?>
<?php if ($this->canShowPriceInfo($baseItem)) : // if current bundle has fixed price ?>

    <tr class="product-row">
    <?php $i = 0; ?>
    <?php foreach($this->getColumns() as $column):?>
        <?php $i++; ?>
        <td class="column-value-<?php echo $this->escapeHtml($column->getProperty())?><?php echo($i == 1 ? ' first' : '') ?><?php echo($i == $this->getColumns()->getSize() ? ' last' : '') ?>">
            <?php if ($column->getProperty() == 'name'): // special rendering for name column ?>
                <div class="cell-content">
                    <div class="item-name"><?php echo $this->renderField($column->getProperty())?></div>
                    <?php foreach($groupedChildItems as $optionId => $optionInfo):?>
                        <?php if ($optionId != 0):?>
                            <div class="item-option-label"><em><?php echo $this->escapeHtml($optionInfo['attribute']['option_label']) ?></em></div>
                            <?php foreach($optionInfo['items'] as $item):?>
                                <?php $this->setItem($item);?>
                                <div class="item-option-value"><?php echo $this->renderField($column->getProperty())?></div>
                            <?php endforeach;?>
                        <?php endif;?>
                    <?php endforeach;?>
                    <?php $this->setItem($baseItem);?>
                </div>
            <?php else : ?>
                <?php if ($this->getItemsGridBlock()->isPriceProperty($column->getProperty())) : ?>
                    <div class="cell-content price-cell"><?php echo $this->renderField($column->getProperty())?></div>
                <?php else : ?>
                    <div class="cell-content"><?php echo $this->renderField($column->getProperty())?></div>
                <?php endif; ?>
            <?php endif; ?>
        </td>
    <?php endforeach;?>
    </tr>

<?php else : // if current bundle has dynamic price ?>

    <?php foreach($groupedChildItems as $optionId => $optionInfo):?>
        <?php if ($optionId != 0 && $nameColumnExists):?>
        <tr class="option-name-row">
            <?php $i = 0; ?>
            <?php foreach ($this->getColumns() as $column):?>
                <?php if ($column->getProperty() == 'name'):?>
                    <td colspan="<?php echo count($this->getColumns()) - $i ?>" class="<?php echo($i == 0 ? 'first ' : '') ?>last">
                        <div class="cell-content">
                            <em><?php echo $this->escapeHtml($optionInfo['attribute']['option_label']) ?></em>
                        </div>
                    </td>
                    <?php break; ?>
                <?php else: ?>
                    <td class="<?php echo($i == 0 ? 'first ' : '') ?>option-indent">&nbsp;</td>
                <?php endif; ?>
                <?php $i++; ?>
            <?php endforeach; ?>
        </tr>
        <?php endif;?>
        <?php foreach($optionInfo['items'] as $item):?>
        <tr class="<?php echo ($optionId == 0 ? 'product-row' : 'option-value-row') ?>">
            <?php $this->setItem($item);?>
            <?php $i = 0; ?>
            <?php foreach($this->getColumns() as $column):?>
                <?php $i++; ?>
                <td class="column-value-<?php echo $this->escapeHtml($column->getProperty())?><?php echo($i == 1 ? ' first' : '') ?><?php echo($i == $this->getColumns()->getSize() ? ' last' : '') ?>">
                    <?php if ($this->getItemsGridBlock()->isPriceProperty($column->getProperty())) : ?>
                        <div class="cell-content price-cell"><?php echo $this->renderField($column->getProperty())?></div>
                    <?php else : ?>
                        <div class="cell-content"><?php echo $this->renderField($column->getProperty())?></div>
                    <?php endif; ?>
                </td>
            <?php endforeach;?>
        </tr>
        <?php endforeach;?>
    <?php endforeach;?>

<?php endif; ?>
<?php $this->setItem($baseItem);?>

