<?php
/**
 * {license_notice}
 *
 * @copyright   {copyright}
 * @license     {license_link}
 */
?>
<?php
/** @var $this Saas_ImportExport_Block_Adminhtml_Export_Result */
?>
<script type="text/javascript">
    //<![CDATA[
    var saasExport = {
        exportFormEl: jQuery('#edit_form select'),
        exportResultEl: jQuery('#export-entity-results'),
        checkDelay: <?php echo $this->getCheckExportTimeout()?>,
        /**
         * Disable export form
         */
        disableExport: function() {
            this.exportFormEl.prop("disabled", true);
        },
        /**
         * Enable export form
         */
        enableExport: function() {
            this.exportFormEl.prop("disabled", false);
        },
        /**
         * Check export progress
         */
        checkStatus: function() {
            var self = this,
                ajaxParams = {
                    url: '<?php echo $this->getCheckExportUrl()?>',
                    type: 'POST',
                    dataType: 'json',
                    data: {form_key: '<?php echo $this->getFormKey()?>'},
                    success: function(response) {
                        if (response.finished) {
                            self.enableExport();
                            self.exportResultEl.html(response.html);
                        } else {
                            jQuery('.export-progress', self.exportResultEl).text(response.message);
                            setTimeout("saasExport.checkStatus()", self.checkDelay);
                        }
                    },
                    error: function() {
                        self.exportResultEl.parents('.export-progress').remove();
                        self.enableExport();
                    }
                };
            jQuery.ajax(ajaxParams)
        }
    };
    <?php if ($this->isExportInProgress()): ?>
        (function($) {
            saasExport.disableExport();
            saasExport.checkStatus();
        })(jQuery);
    <?php endif; ?>
    //]]>
</script>
