<?php
/**
 * {license_notice}
 *
 * @category    Mage
 * @package     Mage_Launcher
 * @copyright   {copyright}
 * @license     {license_link}
 */

/** @var $this Mage_Backend_Block_Template */
?>

<script type="text/javascript">
(function($) {
    var checkPageCompleted = function() {
        var content = $('#store-launcher-content'),
            completeSteps = content.eq(0).find('.tile-complete').length;
        return completeSteps == content.find('article').size();
    };

    // Launch store
    $('#action-launch-store')
        .on('click.launchStore', function(event) {
            var startSuccess = false,
                launchUrl = '<?php echo $this->getUrl('*/storelauncher_index/launch'); ?>',
                ajaxOptions = {
                    type: 'get',
                    showLoader: true,
                    dataType: 'json',
                    async: false,
                    context: $('#launch-my-store-popup'),
                    url: launchUrl,
                    success: function(result, status) {
                        if (result.success) {
                            startSuccess = true;
                            setTimeout(function() {
                                document.location.href = "<?php echo $this->getUrl('*/promotestore_index/index'); ?>";
                            }, 100);
                        } else {
                            alert(result.error_message);
                        }
                    }
                };
            if (checkPageCompleted()) {
                $.ajax(ajaxOptions);
            } else {
                alert($.mage.__('All Tiles have to be completed before this action.'));
            }
            if (!startSuccess) {
                event.preventDefault();
            }
        });

    // Run final checks
    $('#action-final-checks')
        .on('click.runFinalChecks', function() {
            var elem = $(this);

            elem
                .closest('.store-launcher-popup')
                .find('.action-close-store-launcher-popup')
                .trigger('click.closeStoreLauncherPopup');
        });

    // Show storelauncher popup
    $('[data-show-popup]')
        .on('click.showPopup', function() {
            var elem = $(this),
                popupData = elem.data('show-popup'),
                popupElem = $('.' + popupData + '-popup');

            if (checkPageCompleted()) {
                popupElem
                    .closest('.store-launcher-fade')
                    .fadeIn(400, function() {
                        popupElem.animate({
                            top: '50%'
                        });
                    });
            } else {
                alert($.mage.__('All Tiles have to be completed before this action.'));
            }
        });

    // Close storelauncher popup
    $('.action-close-store-launcher-popup')
        .on('click.closeStoreLauncherPopup', function(e) {
            var elem = $(this);

            e.preventDefault();
            elem
                .closest('.store-launcher-popup')
                .animate({
                    top: '-100%'
                })
                .closest('.store-launcher-fade')
                .fadeOut();
        });

    $(document).ready(function() {
        $('#action-launch-my-store').prop("disabled", !checkPageCompleted())
    });
})(jQuery);
</script>

