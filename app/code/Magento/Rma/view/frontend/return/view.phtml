<?php
/**
 * {license_notice}
 *
 * @category    design
 * @package     magento_default
 * @copyright   {copyright}
 * @license     {license_link}
 */
/** @var $this \Magento\Rma\Block\Return\View */
?>
<?php
    $_rma = $this->getRma();
    $_order = $this->getOrder();
    $additionalData = $this->getAdditionalData();
?>

<div class="page-title">
    <h1><?php echo __('RMA') ?> #<?php echo $_rma->getIncrementId()?> - <?php echo $this->escapeHtml($_rma->getStatusLabel()) ?></h1>
</div>

<div class="col2-set">
    <div class="box">
        <div class="box-content">
            <div class="col-1">
                <div class="info-box">
                    <h3 class="box-title"><?php echo __('Request Information') ?></h3>
                    <p class="box-content">
                        <br />
                        <?php echo __('ID') ?>: <?php echo $this->escapeHtml($_rma->getIncrementId()) ?><br />
                        <?php echo __('Order ID') ?>: <a href="<?php echo $this->getOrderUrl($_rma) ?>"><?php echo $this->escapeHtml($_rma->getOrderIncrementId()) ?></a><br />
                        <?php echo __('Date Requested') ?>: <?php echo $this->helper('\Magento\Rma\Helper\Data')->getFormatedDate($_rma->getDateRequested()) ?><br />
                        <?php echo __('Email Address') ?>: <?php echo $this->escapeHtml($_order->getCustomerEmail()) ?><br />
                        <?php echo __('Contact Email Address') ?>: <?php echo $this->escapeHtml($_rma->getCustomerCustomEmail()) ?>
                    </p>
                </div>
            </div>
            <div class="col-2">
                <div class="info-box">
                    <h3 class="box-title"><?php echo __('Shipping Address') ?></h3>
                    <address class="box-content">
                        <?php echo $this->getAddress() ?>
                    </address>
                 </div>
            </div>
        </div>
    </div>
</div>
<div class="wrapper"></div>

<span id="rma-please-wait" class="please-wait" style="display:none;">
    <img src="<?php echo $this->getViewFileUrl('images/opc-ajax-loader.gif') ?>" alt="" class="v-middle" /> <?php echo __('Please wait, loading...') ?>
</span>
<?php $trackingNumbers = $this->getTrackingNumbers() ?>
<?php if ($this->isPrintShippingLabelAllowed() || $trackingNumbers->count()): ?>
    <form method="post" id="rma_track_info">
        <div class="box">
            <div class="box-content">
                <div class="info-box">
                    <h3 class="box-title"><?php echo __('Shipping and Tracking Information') ?></h3>
                    <div class="box-content">
                        <div class="a-right">
                        <?php if ($trackingNumbers->count()): ?>
                            <a class="f-left" href="#"
                               data-mage-init="{popupWindow: {windowURL:'<?php echo $this->helper('\Magento\Rma\Helper\Data')->getTrackingPopupUrlBySalesModel($this->getRma()) ?>',windowName:'trackshipment',width:800,height:600,top:0,left:0,resizable:1,scrollbars:1}}"
                               title="<?php echo __('Track this shipment') ?>">
                                    <?php echo __('Track this shipment') ?>
                            </a>
                        <?php endif ?>
                        <?php if ($this->canShowButtons()): ?>
                            <?php echo $this->getPrintShippingLabelButton() ?>
                            <?php echo $this->getShowPackagesButton() ?>
                        <?php endif; ?>
                        </div>
                        <div class="clear wrapper"></div>
                        <table class="data-table" id="track-info-table">
                            <col width="230" />
                            <col width="350" />
                            <col width="80" />
                            <thead>
                                <tr>
                                    <th><span class="nobr"><?php echo __('Carrier') ?></span></th>
                                    <th><span class="nobr"><?php echo __('Number') ?></span></th>
                                    <th><span class="nobr"><?php echo __('Action') ?></span></th>
                                </tr>
                            </thead>
                            <tbody id="track-info-tbody">
                                <?php echo $this->getTrackingInfo('tracking') ?>
                            </tbody>
                            <?php if ($this->isPrintShippingLabelAllowed()): ?>
                                <tfoot>
                                    <tr>
                                        <td>
                                            <select name="tracking_carrier_select" id="tracking_carrier_select" class="input-text f-fix" data-validate="{required:true}">
                                                <option value = ""></option>
                                                <?php foreach($this->getCarriers() as $key => $value): ?>
                                                    <option value="<?php echo $key ?>"><?php echo $this->escapeHtml($value) ?></option>
                                                <?php endforeach ?>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" class="input-text f-fix" value="" name="tracking_number_input" id="tracking_number_input" data-validate="{required:true}">
                                        </td>
                                        <td>
                                            <button type="button" class="button" id="btn-add-track-number" title="<?php echo __('Add') ?>"><span><span><?php echo __('Add') ?></span></span></button>
                                        </td>
                                    </tr>
                                </tfoot>
                            <?php endif ?>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript">
        jQuery(function() {
            head.js("<?php echo $this->getViewFileUrl('jquery/jquery.validate.js')?>",
                "<?php echo $this->getViewFileUrl('jquery/jquery.metadata.js')?>",
                "<?php echo $this->getViewFileUrl('mage/validation.js')?>",
                "<?php echo $this->getViewFileUrl('mage/validation/validation.js')?>",
                "<?php echo $this->getViewFileUrl('Magento_Rma::rma-track-info.js') ?>", function() {
                    jQuery('#rma_track_info').rmaTrackInfo({
                        addLabelUrl: '<?php echo $this->getAddLabelUrl() ?>'
                    }).validation();
                });
        });
    </script>
    <div class="wrapper"></div>
<?php endif ?>

<h3 class="box-title"><?php echo __('Items Return Requested For') ?></h3>
<table class="data-table" id="my-returns-items-table">
    <col width="200" />
    <col width="200" />
    <col />
    <col />
    <col />
    <col />
    <col />
    <col width="200" />
    <thead>
        <tr>
            <th><span class="nobr"><?php echo __('Product Name') ?></span></th>
            <th><?php echo __('SKU') ?></th>
            <th><?php echo __('Condition') ?></th>
            <th><?php echo __('Resolution') ?></th>
            <th><span class="nobr"><?php echo __('Request Qty') ?></span></th>
            <th><?php echo __('Qty') ?></th>
            <th><?php echo __('Status') ?></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        <?php foreach ($this->getItems() as $key=>$item): ?>
            <?php foreach($this->getRealValueAttributes($item->getId()) as $code=>$attribute) {
                $_qna = NULL;
                if (!in_array($code, $this->getAttributeFilter()) && !empty($attribute['value']) && $this->getAttributeLabel($item->getId(), $code)) {
                    $_qna = '
                        <div class="col-1"><li>' .$this->getAttributeLabel($item->getId(), $code) . '</li></div>
                        <div class="col-2"><li>' . $this->getAttributeValue($item->getId(), $code) . '</li></div>
                        <div class="clear"></div>
                    ';
                }
            } ?>
        <tr>
            <td>
                <?php echo $this->escapeHtml($item->getProductName()) ?>
                <?php if($_options = $this->getItemOptions($item)): ?>
                <dl class="item-options">
                <?php foreach ($_options as $_option) : ?>
                    <dt><?php echo $this->escapeHtml($_option['label']) ?></dt>
                    <dd><?php echo $_option['value'] ?></dd>
                <?php endforeach; ?>
                </dl>
                <?php endif; ?>
            </td>
            <td><?php echo $this->escapeHtml($item->getProductSku()) ?></span></td>
            <td><?php echo $this->escapeHtml($this->getAttributeValue($item->getId(), 'condition')) ?></td>
            <td><?php echo $this->escapeHtml($this->getAttributeValue($item->getId(), 'resolution')) ?></td>
            <td><?php echo $this->escapeHtml($this->helper('\Magento\Rma\Helper\Data')->parseQuantity($item->getQtyRequested(), $item)); ?></td>
            <td><?php echo $this->escapeHtml($this->helper('\Magento\Rma\Helper\Data')->getQty($item));?></td>
            <td><span class="nobr"><?php echo $this->escapeHtml($item->getStatusLabel()) ?></span></td>
            <td>
                <?php if ($_qna) : ?>
                    <button class="l" data-mage-init='{toggleAdvanced: {newLabel: "<?php echo __('Hide Details') ?>", toggleContainers: "#shf_<?php echo $key; ?>"}}'><?php echo __('Show Details') ?></button>
                <?php endif; ?>
            </td>
        </tr>
        <?php if ($_qna) : ?>
            <tr id="shf_<?php echo $key ?>" class="hidden">
                <td colspan="8">
                    <div class="col2-set">
                        <div class="col-1"><?php echo __('Questions') ?>:</div>
                        <div class="col-2"><?php echo __('Answers') ?>:</div>
                        <div class="clear"></div>
                        <?php echo $_qna; ?>
                    </div>
                </td>
            </tr>
        <?php endif; ?>
        <?php endforeach; ?>
        <tr><td colspan="8"></td></tr>
    </tbody>
</table>
<script type="text/javascript">
//<![CDATA[
/**
 * @deprecated
 */
(function($){
    $($('#my-returns-items-table').decorate('table'));
})(jQuery);
//]]>
</script>
<div class="wrapper"></div>
<form method="post" id="rma_comment" action="<?php echo $this->getSubmitUrl() ?>">
    <div class="box">
        <div class="box-content">
            <div class="info-box">
                <h3 class="box-title"><?php echo __('Leave Comment') ?></h3>
                <p class="box-content">
                    <?php echo __('Comment Text') ?>
                    <textarea id="rma_comment_text" style="height:6em;width:99%;" cols="5" rows="3" name="comment" data-validate="{required:true}"></textarea>
                </p>
                <div class="box-content buttons-set">
                    <button type="submit" class="button" id="submit.save"><span><span><?php echo __('Submit Comment')?></span></span></button>
                </div>
                <div class="clear"></div>
                <div class="divider"></div>
                <ul class="note-list box-content">
                    <?php $_comments = $this->getComments(); ?>
                    <?php if (!empty($_comments)): ?>
                    <?php foreach($_comments as $_comment): ?>
                        <?php if ($_comment->getIsVisibleOnFront()): ?>
                        <li>
                            <strong><?php echo $this->formatDate($_comment->getCreatedAt()) ?> <?php echo $this->formatTime($_comment->getCreatedAt()) ?></strong>
                            <span class="separator">|</span>
                            <strong>
                                <?php if ($_comment->getIsAdmin()): ?>
                                    <?php echo __('Customer Service')?>
                                <?php else: ?>
                                    <?php echo $this->escapeHtml($this->getCustomerName())?>
                               <?php endif; ?>
                            </strong>
                            <br />
                            <span>
                                <?php echo nl2br($this->escapeHtml($_comment->getComment())); ?>
                            </span>
                            <div class="divider"></div>
                        </li>
                        <?php endif; ?>
                    <?php endforeach; ?>
                    <?php endif; ?>
                </ul>
            </div>
        </div>
    </div>
</form>
<script type="text/javascript">
    (function($) {
        head.js("<?php echo $this->getViewFileUrl('jquery/jquery.validate.js')?>",
            "<?php echo $this->getViewFileUrl('jquery/jquery.metadata.js')?>",
            "<?php echo $this->getViewFileUrl('mage/validation.js')?>",
            "<?php echo $this->getViewFileUrl('mage/validation/validation.js')?>", function() {
                $('#rma_comment').validation();
            });
    })(jQuery);
</script>
