<?php
/**
 * {license_notice}
 *
 * @category    design
 * @package     default_default
 * @copyright   {copyright}
 * @license     {license_link}
 */
/* @var $this Mage_Catalog_Block_Product_Configurable_AttributeSelector */
?>
<script type="text/javascript">
(function($) {
    'use strict';
    $(function() {
        var $form = $('#affected-attribute-set-form');
        $form
            .dialog({
                title: '<?php echo Mage::helper('Mage_Catalog_Helper_Data')->__('Choose Affected Attribute Set'); ?>',
                autoOpen: false,
                id: '<?php echo $this->getJsId() ?>',
                minWidth: 700,
                modal: true,
                resizable: false,
                buttons: [{
                    text: '<?php echo Mage::helper('Mage_Catalog_Helper_Data')->__('Cancel'); ?>',
                    id: '<?php echo $this->getJsId('close-button') ?>',
                    click: function() {
                        $form.dialog('close');
                    }
                }, {
                    text: '<?php echo Mage::helper('Mage_Catalog_Helper_Data')->__('Confirm'); ?>',
                    id: '<?php echo $this->getJsId('confirm-button') ?>',
                    click: function() {
                        if ($form.find('input[name=affected-attribute-set]:checked').val() == 'current') {
                            $('#new-variations-attribute-set-id').val($('#attribute_set_id').val());
                            $form.dialog('close')
                                .data('target').click();
                            return;
                        }

                        $form.find('.messages .error-msg').hide();
                        $.ajax({
                            type: 'POST',
                            url: '<?php echo $this->getAttributeSetCreationUrl()?>',
                            data: {
                                gotoEdit: 1,
                                attribute_set_name: $form.find('input[name=new-attribute-set-name]').val(),
                                skeleton_set: $('#attribute_set_id').val(),
                                form_key: '<?php echo $this->getFormKey()?>',
                                return_session_messages_only: 1
                            },
                            dataType: 'json',
                            context: $form
                        })
                            .success(function (data) {
                                if (!data.error) {
                                    $('#new-variations-attribute-set-id').val(data.id);
                                    $form.dialog('close')
                                        .data('target').click();
                                } else {
                                    $form.find('.messages .error-msg').replaceWith($(data.messages).find('.error-msg'));
                                }
                            });

                        return false;
                    }
                }]
            })
            .find('input[name=affected-attribute-set]').on('change', function() {
                $('#affected-attribute-set-new-name-container')[$(this).val() == 'new' ? 'show' : 'hide']();
            });

        $('button[data-ui-id=product-edit-save-button],button[data-ui-id=product-edit-save-and-edit-button]')
            .on('click', function(event) {
                if ($('#new-variations-attribute-set-id').val() != '') {
                    return; // affected attribute set was already chosen
                }
                var usedAttributes = $('#associated-products-container').data('usedAttributes') || [],
                    extendingAttributes = [];
                for (var i = 0, length = usedAttributes.length; i < length; i++) {
                    if (!$('#attribute-' + usedAttributes[i].attribute_code + '-container').length) {
                        extendingAttributes.push(usedAttributes[i].attribute_id);
                    }
                }
                if (!extendingAttributes.length) {
                    $('#new-variations-attribute-set-id').val($('#attribute_set_id').val());
                    return; // all selected configurable attributes belong to current attribute set
                }
                if (!$('.associated-matrix-product-id:checked').closest('tr').has('input[name$="\[name\]"]').length) {
                    return; // no new simple products to save from matrix: uniting attribute set is not needed
                }

                event.stopImmediatePropagation();
                $form.data('target', event.target)
                    .dialog('open');
            });
    });
})(jQuery);
</script>
