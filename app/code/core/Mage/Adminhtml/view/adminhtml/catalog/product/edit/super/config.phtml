<?php
/**
 * {license_notice}
 *
 * @category    design
 * @package     default_default
 * @copyright   {copyright}
 * @license     {license_link}
 */
 /** @var $this Mage_Adminhtml_Block_Catalog_Product_Edit_Tab_Super_Config */
?>
<div class="entry-edit" id="<?php echo $this->getId() ?>">
    <div class="entry-edit-head">
        <h4 class="icon-head head-edit-form fieldset-legend">

        <?php echo Mage::helper('Mage_Catalog_Helper_Data')->__('Product Variation') ?>
        </h4>
        <div style="float:right">
            <input type="checkbox" id="<?php echo $this->getId()?>-checkbox" name="attributes"
                value=""
                <?php if ($this->_getProduct()->isConfigurable() || $this->getRequest()->has('attributes')) {
                echo ' checked="checked" ';
            }?>
                />
            <label for="<?php echo $this->getId()?>-checkbox">
                <?php echo Mage::helper('Mage_Catalog_Helper_Data')->__('Does this product have variations?') ?>
            </label>
        </div>
    </div>
    <fieldset>
        <input id="attribute-selector"
            placeholder="start typing to search attribute"
            title="Select Attribute" type="text"
            style="width: 100%; margin: 0px 0px 20px; padding: 5px; box-sizing: border-box; font-size: 1.5em;"
            class="input-text" autocomplete="off">
        <div id="attributes-container">
        <script id="attribute-template" type="text/x-jquery-tmpl">
            <div class="entry-edit attribute-container">
                <input name="attributes[]" id="configurable_attribute_${attribute.id}"
                    value="${attribute.id}" type="hidden">
                <input value="new" type="hidden"
                    name="product[configurable_attributes_data][${attribute.id}]][id]"/>
                <input value="${attribute.id}" type="hidden"
                    name="product[configurable_attributes_data][${attribute.id}][attribute_id]"/>
                <input value="" type="hidden" class="attribute-position"
                    name="product[configurable_attributes_data][${attribute.id}][position]"/>

                <div class="entry-edit-head" style="cursor: move;">
                    <span class="ui-icon ui-icon-arrowthick-2-n-s" style="float:left;"></span>
                    <h4 class="icon-head head-edit-form fieldset-legend">
                        <input value="${attribute.label}"
                            name="product[configurable_attributes_data][${attribute.id}][label]"
                            data-store-label="${attribute.label}"
                            style="background: #6F8992; border: none"
                            class="required-entry"/>
                        <label for="attribute-${attribute.id}">
                            <input value="1"
                                type="checkbox"
                                name="product[configurable_attributes_data][${attribute.id}][use_default]"
                                id="attribute-${attribute.id}"/>
                            <?php echo Mage::helper('Mage_Catalog_Helper_Data')->__('Use default')?>
                    </h4>
                    <span class="ui-icon ui-icon-circle-close" style="float:right"
                        onclick="jQuery(this).parents('.attribute-container:eq(0)').remove();"></span>
                    <span class="ui-icon ui-icon-circle-triangle-s"
                        style="float:right"
                        onclick="jQuery(this).parent().next('fieldset').toggle();"></span>
                </div>
                <fieldset>
                    <table style="width:100%">
                        <thead>
                        <tr>
                            <th>Option Value</th>
                            <th class="column-price">Change Price</th>
                            <th>Include</th>
                        </tr>
                        </thead>
                        <tbody>
                            {{each(index, option) attribute.options}}
                            <tr>
                                <td>${option.label}</td>
                                <td class="column-price">
                                    <input type="hidden"
                                        name="product[configurable_attributes_data][${attribute.id}][values][${option.value}][value_index]"
                                        value="${option.value}">
                                    <input type="text"
                                        name="product[configurable_attributes_data][${attribute.id}][values][${option.value}][pricing_value]"
                                        value="">
                                    <select
                                        name="product[configurable_attributes_data][${attribute.id}][values][${option.value}][is_percent]">
                                        <option value="0">Fixed</option>
                                        <option value="1">Percentage</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="hidden"
                                        name="product[configurable_attributes_data][${attribute.id}][values][${option.value}][include]"
                                        value="0" />
                                    <input type="checkbox"
                                        name="product[configurable_attributes_data][${attribute.id}][values][${option.value}][include]"
                                        value="1" checked="checked" />
                                </td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                    <label>
                        <input type="checkbox" onclick="jQuery(this).closest('.entry-edit')[this.checked ? 'addClass' : 'removeClass']('have-price')" />
                        Have price variation
                    </label>
                </fieldset>
            </div>
        </script>
        <?php
        foreach ($this->getAttributes() as $attribute) {
            $havePriceVariation = array_reduce(
                $attribute['values'],
                function (&$r, $i) {
                    return $r || !empty($i['pricing_value']);
                },
                false
            );
            $id = $this->escapeHtml($attribute['attribute_id']);
        ?>
            <div class="entry-edit attribute-container
            <?php echo $havePriceVariation ? ' have-price' : '' ?>
            " <?php echo $this->getUiId('attrribute-container', $attribute['attribute_code']) ?>>
                <input name="attributes[]" id="configurable_attribute_<?php echo $id?>"
                    value="<?php echo $id; ?>" type="hidden">
                <input value="<?php echo $this->escapeHtml($attribute['id']); ?>" type="hidden"
                    name="product[configurable_attributes_data][<?php echo $id?>][id]" />
                <input value="<?php echo $id; ?>" type="hidden"
                    name="product[configurable_attributes_data][<?php echo $id?>][attribute_id]"/>
                <input value="<?php echo $this->escapeHtml($attribute['position']); ?>" type="hidden" class="attribute-position"
                    name="product[configurable_attributes_data][<?php echo $id?>][position]"/>

                <div class="entry-edit-head" style="cursor: move;">
                    <span class="ui-icon ui-icon-arrowthick-2-n-s" style="float:left;"></span>
                    <h4 class="icon-head head-edit-form fieldset-legend">
                        <input value="<?php echo $this->escapeHtml($attribute['label']); ?>"
                           name="product[configurable_attributes_data][<?php echo $id?>][label]"
                           data-store-label="<?php echo $this->escapeHtml($attribute['label']); ?>"
                           style="background: #6F8992; border: none"
                           class="required-entry"/>
                        <label for="attribute-<?php echo $id?>">
                            <input value="1"
                               type="checkbox"
                               name="product[configurable_attributes_data][<?php echo $id?>][use_default]"
                               id="attribute-<?php echo $id?>" />
                            <?php echo Mage::helper('Mage_Catalog_Helper_Data')->__('Use default')?>
                            ('<?php echo $this->escapeHtml($attribute['store_label']) ?>')</label>
                    </h4>
                    <span class="ui-icon ui-icon-circle-close" style="float:right"
                        onclick="jQuery(this).parents('.attribute-container:eq(0)').remove();"></span>
                    <span class="ui-icon ui-icon-circle-triangle-s"
                        style="float:right"
                        onclick="jQuery(this).parent().next('fieldset').toggle();"></span>
                </div>
                <fieldset>
                    <table style="width:100%">
                        <thead>
                        <tr>
                            <th>Option Value</th>
                            <th class="column-price">Change Price</th>
                            <th>Include</th>
                        </tr>
                        </thead>
                        <tbody>
                        <?php
                            $namePrefix = 'product[configurable_attributes_data][' . $id .'][values]';
                            foreach ($attribute['options'] as $option) {
                        ?>
                            <tr>
                                <td><?php echo $option['label'] ?></td>
                                <td class="column-price">
                                    <?php
                                    $price_value = '';
                                    $isPercent = false;
                                    $include = false;
                                    $valueIndex = $option['value'];
                                    foreach ($attribute['values'] as $priceValue) {
                                        if ($valueIndex == $priceValue['value_index']) {
                                            $price_value = $priceValue['pricing_value'];
                                            $isPercent = (bool)$priceValue['is_percent'];
                                            $include = true;
                                            if (isset($priceValue['include'])) {
                                                $include = $include && (bool)$priceValue['include'];
                                            }
                                            break;
                                        }
                                    }
                                    ?>
                                    <input type="hidden"
                                           name="<?php echo $namePrefix ?>[<?php echo $valueIndex ?>][value_index]"
                                           value="<?php echo $this->escapeHtml($valueIndex); ?>">
                                    <input type="text"
                                        name="<?php echo $namePrefix ?>[<?php echo $valueIndex ?>][pricing_value]"
                                        value="<?php echo $this->escapeHtml($price_value); ?>">
                                    <select name="<?php echo $namePrefix ?>[<?php echo $valueIndex ?>][is_percent]">
                                        <option value="0"
                                            <?php echo !$isPercent ?'selected="selected"':'' ?>
                                            >Fixed</option>
                                        <option value="1"
                                            <?php echo $isPercent ? 'selected="selected"' : '' ?>
                                            >Percentage</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="hidden"
                                       name="<?php echo $namePrefix ?>[<?php echo $valueIndex ?>][include]"
                                       value="0" />
                                    <input type="checkbox"
                                       name="<?php echo $namePrefix ?>[<?php echo $valueIndex ?>][include]"
                                       value="1" <?php echo $include ? 'checked="checked"' : ''; ?> />
                                </td>
                            </tr>
                        <?php } ?>
                        </tbody>
                    </table>
                    <label><input type="checkbox"
                        <?php echo $havePriceVariation ? 'checked="checked"' : '' ?>
                        onclick="jQuery(this).closest('.entry-edit')[this.checked ? 'addClass' : 'removeClass']('have-price')"/> Have price variation</label>
                </fieldset>
            </div>
        <?php } ?>
        </div>
        <?php  echo $this->getChildHtml('generate'); ?>
<?php
//echo $this->getChildHtml('super_settings');
if (count($this->getSelectedAttributes())) {
?>
<a href="#" name="matrix"></a>
<div id="product-variations-matrix" class="grid" style="margin:20px 0">
<?php
    $variations = $this->getVariations();
    $usedProductAttributes = $this->getSelectedAttributes();
?>
    <table cellspacing="0">
        <thead>
        <tr class="headings">
            <th width="180">Product Name <span class="required">*</span></th>
            <th width="180">Price <span class="required">*</span></th>
            <th width="220">SKU <span class="required">*</span></th>
            <th width="180">Quantity</th>
            <th width="180">Weight</th>
<?php
    foreach ($usedProductAttributes as $attribute) {
        /** @var $attribute Mage_Catalog_Model_Resource_Eav_Attribute */
        echo '<th>', $attribute->getStoreLabel(), '</th>', PHP_EOL;
    }
?>
            <th class="a-center" width="55">Include</th>
        </tr>
        </thead>
        <tbody>
<?php
    $isEven = true;
    $productPrice = (float)$this->_getProduct()->getPrice();
    $productByUsedAttributes = array();
    foreach ($this->_getProduct()->getTypeInstance()->getUsedProducts($this->_getProduct()) as $product) {
       $keys = array();
       foreach ($usedProductAttributes as $attribute) {
           /** @var $attribute Mage_Catalog_Model_Resource_Eav_Attribute */
           $keys[] = $product->getData($attribute->getAttributeCode());
       }
       $productByUsedAttributes[implode('-', $keys)] = $product;
    }

    foreach ($variations as $variation) {
        $attributeValues = array();
        $attributeLabels = array();
        $price = $productPrice;
        foreach ($usedProductAttributes as $attribute) {
            /** @var $attribute Mage_Catalog_Model_Resource_Eav_Attribute */
            $attributeValues[$attribute->getAttributeCode()] = $variation[$attribute->getId()]['value'];
            $attributeLabels[$attribute->getAttributeCode()] = $variation[$attribute->getId()]['label'];
            if (isset($variation[$attribute->getId()]['price'])) {
                $priceInfo = $variation[$attribute->getId()]['price'];
                $price += ($priceInfo['is_percent'] ?  $productPrice / 100.0 : 1.0) * $priceInfo['pricing_value'];
            }
        }
        $key = implode('-', $attributeValues);
        if (isset($productByUsedAttributes[$key])) {
            $product = $productByUsedAttributes[$key];
?>
        <tr class="<?php echo $isEven ? 'even' : '' ?>">
            <td class="associated-matrix-product-name"><?php echo $product->getName()?></td>
            <td class="associated-matrix-product-price"><?php echo $price ?></td>
            <td><span class="associated-matrix-product-sku"><?php echo $product->getSku()?></span>
                <button class="choose-product"
                    data-attributes="<?php echo $this->escapeHtml($this->helper('Mage_Core_Helper_Data')->jsonEncode($attributeValues)); ?>"
                    style="float:right">
                    Choose
                </button>
            </td>
            <td class="associated-matrix-product-qty"><?php echo $product->getStockItem()->getQty()?></td>
            <td class="associated-matrix-product-weight"><?php echo $product->getWeight()?></td>
            <td><?php echo implode('</td><td>', $attributeLabels)?></td>
            <td class="a-center"><input type="checkbox" name="associated_product_ids[]" value="<?php echo $product->getId()?>" class="checkbox associated-matrix-product-id" checked="checked"></td>
        </tr>
<?php
        } else {
            $checked = $this->_getProduct()->getId() && !$this->_getProduct()->dataHasChangedFor('type_id') ? '' : ' checked="checked"';
            $disabled = $this->_getProduct()->getId() && !$this->_getProduct()->dataHasChangedFor('type_id') ? ' disabled="disabled"' : '';
?>
        <tr class="<?php echo $isEven ? 'even' : '' ?>">
            <td class="associated-matrix-product-name">
                <input id="variations-matrix-<?php echo $key?>-name" name="variations-matrix[<?php echo $key?>][name]" value="<?php echo $this->_getProduct()->getName(), '-', implode('-', $attributeLabels)?>" class="required-entry"<?php echo $disabled?>/>
                <input type="hidden" name="variations-matrix[<?php echo $key?>][configurable_attribute]" value="<?php echo $this->escapeHtml($this->helper('Mage_Core_Helper_Data')->jsonEncode($attributeValues)); ?>"<?php echo $disabled?>/>
            </td>
            <td class="associated-matrix-product-price">
                <?php echo $price ?>
                <input type="hidden" id="variations-matrix-<?php echo $key?>-price" name="variations-matrix[<?php echo $key?>][price]" value="<?php echo $price ?>" class="required-entry"<?php echo $disabled?>/>
            </td>
            <td class="associated-matrix-product-sku">
                <input id="variations-matrix-<?php echo $key?>-sku" name="variations-matrix[<?php echo $key?>][sku]" value="<?php echo $this->_getProduct()->getSku(), '-', implode('-', $attributeLabels)?>" class="required-entry"<?php echo $disabled?>/>
                <button class="choose-product"
                    data-attributes="<?php echo $this->escapeHtml($this->helper('Mage_Core_Helper_Data')->jsonEncode($attributeValues)); ?>"
                    style="float:right">
                    Choose
                </button>
            </td>
            <td class="associated-matrix-product-qty">
                <input id="variations-matrix-<?php echo $key?>-qty" name="variations-matrix[<?php echo $key?>][quantity_and_stock_status][qty]" value=""<?php echo $disabled?>>
            </td>
            <td class="associated-matrix-product-weight">
                <input id="variations-matrix-<?php echo $key?>-weight" name="variations-matrix[<?php echo $key?>][weight]" value="<?php echo $this->_getProduct()->getWeight()?>"<?php echo $disabled?>>
            </td>
            <td><?php echo implode('</td><td>', $attributeLabels)?></td>
            <td class="a-center">
                <input type="checkbox" name="associated_product_ids[]" value="" class="checkbox associated-matrix-product-id"<?php echo $checked?>>
            </td>
        </tr>
<?php
        }
        $isEven = !$isEven;
    }
?>
        </tbody>
    </table>
</div>

<div id="associated-products-container"  data-used-attributes="<?php echo $this->escapeHtml($this->helper('Mage_Core_Helper_Data')->jsonEncode($this->getAttributes())); ?>" style="display: none;">
    <?php echo $this->getGridHtml(); ?>
</div>

<div><input type="hidden" name="affect_configurable_product_attributes" value="1" /></div>
<?php } ?>

</fieldset>

<script type="text/javascript">
jQuery(function($) {
    var usedAttributes = jQuery('#associated-products-container').data('usedAttributes') || [];
    $('#attributes-container').sortable({
        axis: "y",
        handle: '.entry-edit-head',
        containment: "parent",
        update: function (event, ui) {
            $(this).find('.attribute-position').each(function(index){
                $(this).val(index)
            })
        }
    });

    $("#<?php echo $this->getId()?>-checkbox").on('click change', function() {
        var $fieldset = $("#<?php echo $this->getId()?> > fieldset");
        if ($(this).is(':checked')) {
            $fieldset.show();
            $("#<?php echo $this->getId()?> input[name='attributes[]']").removeAttr('disabled');
            $('#qty').attr('disabled', true);
            $.each(usedAttributes, function() {
                $('#attribute-' + this.attribute_code + '-container select').attr('disabled', true);
            });
        } else {
            $('#qty').removeAttr('disabled');
            $("#<?php echo $this->getId()?> input[name='attributes[]']").attr('disabled', true);
            $.each(usedAttributes, function() {
                $('#attribute-' + this.attribute_code + '-container select').removeAttr('disabled');
            });
            $fieldset.hide();
        }
    }).trigger('change');

    var $gridDialog = $('#associated-products-container').dialog({
        title:'Select Associated Product',
        autoOpen:false,
        minWidth:980,
        modal:true,
        resizable:true
    });

    $.each($('#product-variations-matrix input[type!="checkbox"][type!="hidden"]'), function(key, input) {
        var $input = $(input),
            name = $input.attr('name'),
            $parentInput = $('#' + name.match(/\[(\w+)\]$/)[1]),
            classes = $parentInput.attr('class');
        if (classes) {
            $.each(classes.split(/\s+/), function (k, v) {
                if (v.indexOf('validate-') === 0) {
                    $input.addClass(v);
                }
            });
        }
    });

    $('#product-variations-matrix').on('click', 'input.associated-matrix-product-id', function() {
        $(this).closest('tr').find('input[type!=checkbox]').prop('disabled', !$(this).is(':checked'));
    });
    $('#product-variations-matrix').on('click', '.choose-product', function(event) {
        event.preventDefault();
        var grid = window.<?php echo $this->getGridJsObject() ?>;
        var $button = $(this);
        grid.reloadParams = {
            'filter': $button.data('attributes'),
            'attributes[]': Object.values(usedAttributes).map(function(el) { return el.attribute_id; })
        };
        grid.reload(null, function() {
            $gridDialog.dialog('open')
        });

        grid.rowClickCallback = function(grid, event) {
            if (!this.rows || !this.rows.length) {
                return;
            }
            var $matrixRow = $button.parents('tr');
            var $gridRow = $(event.target).parents('tr');
            var matrixClass = '.associated-matrix-product-';
            var associatedClass = '.associated-product-';
            var productFields = ['name', 'price', 'sku', 'qty', 'weight', 'id'];

            if ($gridRow.find(associatedClass + 'id').length) {
                $.each(productFields, function () {
                    var target = $matrixRow.find(matrixClass + this),
                        value = $.trim($gridRow.find(associatedClass + this).text()),
                        button = target.find('button.choose-product');
                    target[target.is('input[type=checkbox]') ? 'val' : 'html'](value).append(button);
                });
                $matrixRow.find(matrixClass + 'id').attr('checked', true).removeAttr('disabled');
            }
            $gridDialog.dialog('close');
        };
    });
});
</script>
</div>
