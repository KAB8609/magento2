<?php
/**
 * {license_notice}
 *
 * @category    design
 * @package     default_default
 * @copyright   {copyright}
 * @license     {license_link}
 */

/** @var $this Mage_Adminhtml_Block_Tax_Rule_Edit_Form */
?>
<script type="text/javascript">
    (function ($) {
        function toggleLoadingMask()
        {
            var loaderArea = $('#html-body .wrapper')[0],
                loadingMask = $('#loading-mask');

            loadingMask.css({
                top:  0,
                left: 0,
                width: document.body.offsetWidth,
                height: document.body.offsetHeight,
                'z-index':1005
            });
            loadingMask.toggle();
            toggleSelectsUnderBlock($('loading-mask'), false);
        }

        $.widget("adminhtml.dialogRates", $.ui.dialog, {
            options: {
                itemRate: {},
                itemRateDefault: {}
            },
            _create: function() {
                $.ui.dialog.prototype._create.apply(this);
                this._getFormData(this.options.itemRateDefault);
            },
            open: function() {
                if (this._trigger('beforeOpen', null, this) === false) {
                    return;
                }
                this._applyItem();
                $.ui.dialog.prototype.open.apply(this);

            },
            close: function() {
                $.ui.dialog.prototype.close.apply(this);
            },
            _applyItem: function() {
                var rate = this.options.itemRateDefault,
                        dialogElement = this.uiDialog;
                if (this.options.itemRate && !$.isEmptyObject(this.options.itemRate)) {
                    rate = this.options.itemRate;
                }
                $.each(rate, function(key, value) {
                    dialogElement.find('[name="' + key + '"]').attr('value', value);
                });

            },
            updateItemRate: function() {
                this._getFormData(this.options.itemRate);
            },
            _getFormData: function(data) {
                $.each(this.uiDialog.find(':input'), function() {
                    if (this.name) {
                        data[this.name] = this.value
                    }
                });
            }
        });

        $().ready(function () {
            var options = {
                    toggleAddButton:false,
                    addText: '<?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Add New Tax Rate'); ?>',
                    parse: null
                },
                taxRateField = $('#tax_rate').parent(),
                taxRateForm = $('#tax-rate-form');

            $('#tax_rate').multiselect(options);

            taxRateField.find('.mselect-button-add').off('click');

            taxRateField.find('.mselect-list')
                .on('click.mselect-edit', '.mselect-edit', function () {
                    var that = $(this),
                        index = that.parent().index(),
                        select = that.closest('.mselect-list').prev(),
                        id = select.find('option').eq(index).attr('value'),
                        item;

                    for(var i = 0, c = taxRateCollection.length; i < c; i++) {
                        if (taxRateCollection[i].tax_calculation_rate_id == id) {
                            item = taxRateCollection[i];
                            break;
                        }
                    }
                    item.itemElement = that.prev();
                    taxRateForm
                        .dialogRates({itemRate: item})
                        .dialogRates('open');
                })
                .on("click.mselect-delete", ".mselect-delete", function () {
                    if (!confirm('<?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Do you really want to delete this tax rate'); ?>')) {
                        return;
                    }

                    var that = $(this),
                        index = that.parent().index(),
                        select = that.closest('.mselect-list').prev();

                    var ajaxOptions = {
                        type: 'POST',
                        data: {
                            tax_calculation_rate_id: select.find('option').eq(index).val(),
                            form_key: $('input[name="form_key"]').val()
                        },
                        dataType: 'json',
                        url: '<?php echo $this->getTaxRateDeleteUrl()?>',
                        success: function(result, status) {
                            if (result.success) {
                                that.parent().remove();
                                select.find('option').eq(index).remove();
                            } else {
                                alert(result.error_message);
                            }
                        }
                    };
                    $.ajax(ajaxOptions);

                })
                .on('click.mselectAdd', '.mselect-button-add', function () {
                    taxRateForm
                        .dialogRates({itemRate: {}})
                        .dialogRates('open');
                })
                .on('click.mselect-checked', '.mselect-list-item input', function (event) {
                    var el = $(this),
                        checkedClassName = 'mselect-checked';
                    el[el.is(':checked') ? 'addClass' : 'removeClass'](checkedClassName);
                });

            taxRateForm.dialogRates({
                title: '<?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Tax Rate'); ?>',
                autoOpen: false,
                id: '<?php echo $this->getJsId() ?>',
                minWidth: 560,
                modal: true,
                resizable: false,
                buttons: [{
                    text: '<?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Cancel'); ?>',
                    id: '<?php echo $this->getJsId('close-button') ?>',
                    click: function() {
                        $(this).dialogRates("close");
                    }
                }, {
                    text: '<?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Save'); ?>',
                    id: '<?php echo $this->getJsId('apply-button') ?>',
                    click: function() {
                        $(this).dialogRates('updateItemRate');
                        var itemRate = $(this).dialogRates('option').itemRate,
                            itemRateData = $.extend({}, itemRate);
                        if (itemRateData.itemElement) {
                            delete itemRateData.itemElement;
                        }

                        toggleLoadingMask();

                        var ajaxOptions = {
                            type: 'POST',
                            data: itemRateData,
                            dataType: 'json',
                            url: '<?php echo $this->getTaxRateSaveUrl()?>',
                            success: function(result, status) {
                                if (result.success) {
                                    itemRate.code = result.code;
                                    if (itemRate.tax_calculation_rate_id) {
                                        itemRate.itemElement.find('span').html(itemRate.code);
                                        var index = itemRate.itemElement.parent().index();
                                        itemRate.itemElement.closest('.mselect-list').prev().find('option').eq(index)
                                                .html(itemRate.code)
                                                .val(itemRate.tax_calculation_rate_id);
                                    } else {
                                        itemRate.tax_calculation_rate_id = result.tax_calculation_rate_id;
                                        taxRateField.find('.mselect-input').val(itemRate.code);
                                        taxRateField.find('.mselect-save').trigger('mousedown');
                                        taxRateField.find('option[value="' + itemRate.code + '"]')
                                                .val(itemRate.tax_calculation_rate_id);
                                    }
                                    taxRateForm.dialogRates("close");
                                    taxRateCollection.push(itemRate);
                                } else {
                                    alert(result.error_message);
                                }
                                toggleLoadingMask();
                            }
                        };
                        $.ajax(ajaxOptions);
                    }
                }]
            });
        })
    })(jQuery);
</script>
