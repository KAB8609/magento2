<?php
/**
 * {license_notice}
 *
 * @category    design
 * @package     default_default
 * @copyright   {copyright}
 * @license     {license_link}
 */
?>
<div class="entry-edit">
    <!-- Import Tax Rates -->
    <?php if (!$this->getIsReadonly()): ?>

    <div class="box-left">
        <div class="entry-edit-head">
            <h4 class="icon-head head-edit-form fieldset-legend"><?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Import Tax Rates'); ?></h4>
        </div>
        <fieldset>
            <legend><?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Import Tax Rates'); ?></legend>
            <ul class="messages" style="display: none;">
                <li class="error-msg" id="import-rate-errors"></li>
            </ul>
            <span class="fileinput-button">
                <span><?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Import CSV File'); ?></span>
                <input type="file" id="import_rates_file" name="import_rates_file" class="input-file" data-url="<?php echo $this->getUrl('*/storelauncher_tax_drawer/importTaxRates'); ?>" />
            </span>
        </fieldset>
    </div>
    <script type="text/javascript">
    //<![CDATA[
        (function ($) {
            var importRateFormKey = $('input[name="form_key"]').val();
            $('#import_rates_file').fileupload({
                dataType: 'json',
                formData: {
                    isAjax: 'true',
                    form_key: importRateFormKey
                },
                sequentialUploads: false,
                done: function(e, data) {
                    var messageContainer = $('#import-rate-errors');
                    if (data.result.success == true) {
                        messageContainer.parent().hide();
                        updateTaxRateMultiselect(data.result);
                        return;
                    } else {
                        messageContainer.text(data.result.error_message);
                        messageContainer.parent().show();
                        return;
                    }
                },
                fail: function(e, data) {
                    var messageContainer = $('#import-rate-errors');
                    messageContainer.text('<?php echo Mage::helper('Mage_Launcher_Helper_Data')->__('There was an error processing your request.'); ?>');
                    messageContainer.parent().show();
                    return;
                },
                add: function(e, data) {
                    $(this).fileupload('process', data).done(function () {
                        data.submit();
                    });
                }
            });

            /**
             * Refresh tax Rate Field
             *
             * @param Array import rates request result
             */
            var updateTaxRateMultiselect = function(result) {
                var taxRow = $('#tax_rate').parent().parent(),
                    prev = taxRow.prev();
                taxRow.remove();
                // Next variable is global for tax rule page and is used in edit tax rate pop-up
                taxRateCollection = result.tax_rate_collection;
                prev.after(result.tax_rate_field);
                return;
            }
        }(jQuery));
    //]]>
    </script>

    <?php endif; ?>

    <!-- Export Tax Rates -->
    <div class="<?php if ($this->getIsReadonly()): ?>box-left<?php else: ?>box-right<?php endif; ?>">
        <div class="entry-edit-head">
            <h4 class="icon-head head-edit-form fieldset-legend"><?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Export Tax Rates'); ?></h4>
        </div>
        <fieldset>
            <legend><?php echo Mage::helper('Mage_Tax_Helper_Data')->__('Export Tax Rates'); ?></legend>
            <a href="<?php echo $this->getUrl('adminhtml/tax_rate/exportPost'); ?>"><?php echo Mage::helper('Mage_Tax_Helper_Data')->__('CSV Format Guidelines'); ?></a>
        </fieldset>
    </div>
    <div class="clear"></div>
</div>
