<script type="text/javascript">
var Shipping = Class.create();
Shipping.prototype = {
    initialize: function(form){
        this.form = form;
        this.onAddressLoad = this.fillForm.bindAsEventListener(this);
        this.onSave = this.continue.bindAsEventListener(this);
    },

    setAddress: function(addressId){
        if (addressId) {
            request = new Ajax.Request(
                '<?=$baseSecureUrl?>checkout/onepage/getAddress/address/'+addressId,
                {
                    method:'get',
                    onSuccess: this.onAddressLoad
                }
            );
        }
        else {
            this.fillForm(false);
        }
    },
    
    resetSelectedAddress: function(){
        var selectElement = $('shipping-address-select')
        if (selectElement) {
            selectElement.value='';
        }
    },

    fillForm: function(transport){
        var elementValues = {};
        if (transport && transport.responseText){
            try{
                elementValues = eval('(' + transport.responseText + ')');
            }
            catch (e) { 
                elementValues = {};
            }
        }
        else{
            this.resetSelectedAddress();
        }
        arrElements = Form.getElements(this.form);
        for (var elemIndex in arrElements) {
            if (arrElements[elemIndex].id) {
                var fieldName = arrElements[elemIndex].id.replace(/shipping:/, '');
                arrElements[elemIndex].value = elementValues[fieldName] ? elementValues[fieldName] : '';
                if (fieldName == 'country_id' && shippingForm){
                    shippingForm.elementChildLoad(arrElements[elemIndex]);
                }
            }
        }
    },
    
    save: function(){
        var validator = new Validation(this.form);
        if (validator.validate()) {
            var request = new Ajax.Request(
                '<?=$baseSecureUrl?>checkout/onepage/saveShipping/',
                {
                    method:'post',
                    onSuccess: this.onSave,
                    parameters: Form.serialize(this.form)
                }
            );
        }
    },

    continue: function(){
        var updater = new Ajax.Updater('checkout-shipping-method-load', '<?=$baseSecureUrl?>checkout/onepage/shippingMethod/', {method:'get'});
        checkout.setShipping();
    }
}
</script>

<div class="step-body">
    <?if(!empty($addresses)):?>
    <div class="note-box" style="display:block;">
        <p class="option">
            Select a shipping address from your address book or enter a &nbsp;
            <a href="#" onclick="shipping.setAddress(false); return false;">new address</a>
        </p>
        <select id="shipping-address-select" name="" style="width:100%;" onchange="shipping.setAddress(this.value);">
            <option value="">New address</option>
        <?foreach($addresses as $_addressId=>$_address):?>
            <option value="<?=$_address->getAddressId()?>" <?if($_address->getAddressId() == $address->getAddressId()):?> selected<?endif?>>
                <?=$_address->getFirstname()?> <?=$_address->getLastname()?> [<?=$_address->getStreet(-1)?>, <?=$_address->getPostcode()?>, <?=$_address->getCity()?>] [<?=$_address->getTelephone()?>]
            </option>
        <?endforeach?>
        </select>
    </div>
    <?endif?>
    <div class="default-box" style="display:block;">
        <form id="co-shipping-form">
            <input type="hidden" name="shipping[address_id]" value="<?=$address->getAddressId()?>" id="shipping:address_id">
            <fieldset>
            <ul class="input-list">
                <li>
                    <div class="input-left">
                        <label for="shipping:firstname">First Name <span class="required">*</span></label><br/>
                        <input type="text" id="shipping:firstname" name="shipping[firstname]" value="<?=$address->getFirstname()?>" title="First Name" class="required-entry input-text"/>
                    </div>
                    <div class="input-right">
                        <label for="shipping:lastname">Last Name <span class="required">*</span></label><br/>
                        <input type="text" id="shipping:lastname" name="shipping[lastname]" value="<?=$address->getLastname()?>" title="Last Name" class="required-entry input-text"/>
                    </div>
                    <div class="clearfix"></div>
                </li>
                <li>
                    <div class="input-left">
                        <label for="shipping:company">Company</label><br/>
                        <input type="text" id="shipping:company" name="shipping[company]" value="<?=$address->getCompany()?>" title="Company" class="input-text"/>
                    </div>
                    <!--
                    <div class="input-right">
                        <label for="shipping:email_address">Email <span class="required">*</span></label><br/>
                        <input type="text" id="shipping:email_address" title="Email Address" class="validate-email required-entry input-text"/>
                    </div>
                    -->
                    <div class="clearfix"></div>
                </li>
                <li>
                    <label for="shipping:street_address">Street Address <span class="required">*</span></label><br/>
                    <input type="text" title="Street Address" name="shipping[street][1]" id="shipping:street1" value="<?=$address->getStreet(1)?>" class="required-entry input-text"/>
                </li>
                <li>
                    <input type="text" title="Street Address 2" name="shipping[street][2]" id="shipping:street2" value="<?=$address->getStreet(2)?>" class="input-text"/>
                </li>
                <li>
                    <label for="shipping:city">City <span class="required">*</span></label><br/>
                    <input type="text" title="City" name="shipping[city]" value="<?=$address->getCity()?>" class="required-entry input-text" id="shipping:city"/>
                </li>
                <li>
                    <div class="input-left">
                        <label for="shipping:zone_id">State / Province <span class="required">*</span></label><br/>
                        <?if($regions->getSize()):?>
                            <select title="State/Province" id="shipping:region" name="shipping[region_id]" class="validate-select required-entry">
                                <option value="">Select State/Province...</option>
                                <?=$regions->toHtmlOptions($address->getRegionId())?>
                            </select>
                        <?else:?>
                            <input type="text" id="shipping:region" name="shipping[region]" value="<?=$address->getRegion()?>"  title="State/Province" class="required-entry input-text"/>
                        <?endif?>
                    </div>
                    <div class="input-right">
                        <label for="shipping:postcode">Zip <span class="required">*</span></label><br/>
                        <input type="text" title="ZIP/Post Code" name="shipping[postcode]" id="shipping:postcode" value="<?=$address->getPostcode()?>" class="validate-zip required-entry input-text"/>
                    </div>
                    <div class="clearfix"></div>
                </li>
                <li>
                    <label for="shipping:country_id">Country <span class="required">*</span></label><br/>
                    <select id="shipping:country_id" name="shipping[country_id]" title="Country">
                        <?=$countries->toHtmlOptions($address->getCountryId())?>
                    </select>
                </li>
                <li>
                    <div class="input-left">
                        <label for="shipping:telephone">Telephone <span class="required">*</span></label><br/>
                        <input type="text" name="shipping[telephone]" value="<?=$address->getTelephone()?>" title="Telephone" class="required-entry validate-phoneStrict input-text" id="shipping:telephone"/></div>
                    <div class="input-right">
                        <label for="shipping:fax">Fax</label><br/>
                        <input type="text" name="shipping[fax]" value="<?=$address->getFax()?>" title="Fax" class="validate-fax input-text" id="shipping:fax"/>
                    </div>
                    <div class="clearfix"></div>
                </li>
            </ul>
        </fieldset>
        </form>
    </div>
    <div class="note-box">
        <p class="a-right"><span class="required">* Required Fields</span></p>
        <input type="button" onclick="checkout.back();" value="Back" class="input-button float-left"/>
        <input type="button" onclick="shipping.save();" class="input-button float-right" value="Continue"/>
        <div class="clearfix"></div>
    </div>
</div>

<script type="text/javascript">
    var shipping = new Shipping('co-shipping-form');
    var shippingForm = new VarienForm('co-shipping-form');
    shippingForm.setElementsRelation('shipping:country_id', 'shipping:region', '<?=$baseSecureUrl?>directory/json/childRegion/');
</script>
