<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2004-2007 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
?>
<div class="entry-edit">
	<h4 class="icon-head head-edit-form fieldset-legend"><?=__('Roles Resources')?></h4>
	<fieldset id="role_resources">
		<?$_level = 0;?>
		<?foreach ($resources as $_resource => $val):?>
		<?
		  	$_next = next($resources);
		  	if( $_next['level'] < $val['level'] ) {
				$_class = 'tree_item_last';
			} else {
				$_class = 'tree_item';
			}
			$_margin = $val['level'] * 18;
			$_lineWidht = ( $_margin == 0 ) ? 25 : $_margin ;
		?>
			<div id="_<?=$_resource?>" style="position:relative;">
				<div style="width:<?=$_lineWidht?>px;" class="tree_line">&nbsp;</div>
				<div class="<?=$_class?>" style="margin-left:<?=$_margin?>px;">
					<input type="checkbox" value="<?=$_resource?>" id="<?=str_replace('/', '_', rtrim($_resource, '/'))?>" title="<?=$val['name']?>" name="resource[]" <? if( isset($val['checked']) && $val['checked'] === true ) echo 'checked="true"';?> onchange="resource._toggle(this)" />
					<label for="<?=str_replace('/', '_', rtrim($_resource, '/'))?>" class="normal <? if( isset($val['checked']) && $val['checked'] === true ) echo 'bold';?>"><?=$val['name'];?></label>
				</div>
			</div>
		<?php endforeach; ?>
	</fieldset>
</div>
<script type="text/javascript">
    var resource = function () {
    	return {
    		_getCheckboxes: function (obj) {
                checkboxes = document.getElementsByTagName('input');
                children = new Array();
                for( i in checkboxes ) {
                    if( checkboxes[i].type == 'checkbox' && checkboxes[i].id.match(obj.id+'_') ) {
                        children.unshift(checkboxes[i])
                    }
                }
                return children;
       		},

       		_getParentCheckboxes: function (obj) {
                var ids = obj.id.split('_');
                var parents = new Array();
                var path = "admin";
                for( x=0; x<ids.length; x++){
                	var key = ids[x];
                	if (key == "admin") continue;
                	var o = this._findCheckboxById(path+"_"+key);
                	if (o) {
                		path = path + "_" + key;
                		parents.push(o);
                	}
                }
                return parents;
       		},

       		_toggle: function(obj) {
       		    var objState = obj.checked;

       		    if (objState) {
       		    	var parents = this._getParentCheckboxes(obj);
       		    	if (parents.length > 0) {
       		    		for(var y in parents){
       		    			parents[y].checked = objState;
       		    		}
       		    	}
       		    }

       		    checkboxes = this._getCheckboxes(obj);
       		    for( i in checkboxes ) {
       		        checkboxes[i].checked = objState;
       		    }
       		},

       		_findCheckboxById: function(id)
       		{
       			var tmp = document.getElementsByTagName('input');
       			for(var i in tmp){
       				if ( tmp[i].id == id && tmp[i].type == 'checkbox' ) return tmp[i];
       			}
       			return null;
       		}
    	}
    }();
</script>
