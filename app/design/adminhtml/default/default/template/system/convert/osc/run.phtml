<div id="store_list" style="display: none;">
</div>
<div id="import_processing" style="display: none; font-size: 16px" >
<ul class="messages"><li class="warning-msg"><ul><li>Importing...</li></ul></li></ul>
</div>

<div id="import_done" style="display:none;font-size: 16px"><ul class="messages"><li class="success-msg"><ul><li>Data has been successfully doned</li></ul></li></ul></div>
<?php echo $this->getSaveButtonHtml() ?>

<script type="text/javascript">
Event.observe($('run_import'), 'click', function(){
    var url = '<?php echo $this->getUrl('*/*/run', array('id'=>$this->getOscId())) ?>';
    var store = $('store_list');
    if (store.childElements().length == 0) {
        new Ajax.Request('<?php echo $this->getUrl('*/*/checkStore', array('id'=>$this->getOscId())) ?>',
            {
                method: 'post',
                onSuccess: function(transport) {
                    var response = transport.responseText;
                    if (response) {
                        showForm(response);
                        return false;
                    } 
                    window.open(url);
                },
                onFailture: function() {
                    alert('Error!');           
                }
            }
        );
    } else {
        var sel = store.getElementsBySelector('select');
        var locale = '';
        if (sel.length > 0) for (var i = 0; i < sel.length; i++) {
            locale += (locale?'|':'') + sel[i].id.replace('store_locale_', '') + ':' + sel[i].value;
        }
        url += 'store_locale/'+locale;
        Element.hide($('store_list'));
        Element.toggle($('import_processing'));
        Element.toggle($('run_import'));       
//        window.open(url);
        new Ajax.Request(url,
            {
                method: 'post',
                onSuccess: function(transport) {
                    var response = transport.responseText;
                    if (response) {
                        Element.toggle($('import_processing'));
                        Element.toggle($('import_done')); 
                    }
                },
                onFailture: function() {
                    alert('Error!');           
                }
            }
        );


    }
});

function showForm(o)
{
    if (o != undefined) {
        $('store_list').update(o);
        Element.show($('store_list'));
    }
}
</script>

