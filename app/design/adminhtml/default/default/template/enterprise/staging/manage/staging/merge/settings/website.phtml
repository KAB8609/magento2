<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design_default
 * @package    Enterprise
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php /* @var $this Enterprise_Staging_Block_Manage_Staging_Merge_Settings_Website */?>
<?php $staging          = $this->getStaging(); ?>
<?php $items            = $staging->getItemsCollection(); ?>
<?php $masterWebsites   = $this->getWebsiteCollection(); ?>
<?php $stagingWebsites  = $staging->getWebsitesCollection(true); ?>
<div>
    <h3 class="icon-head head-categories"><?php echo $staging->getName(); ?></h3>
</div>
<?php if($this->getPagerVisibility() || $this->getExportTypes() || $this->getFilterVisibility()): ?>
    <table cellspacing="0" class="actions">
        <tr>
    <?php if($this->getExportTypes()): ?>
        <td class="export a-right">
            <img src="<?php echo $this->getSkinUrl('images/icon_export.gif') ?>" alt="" class="v-middle"/>&nbsp; <?php echo $this->__('Export to:') ?>
            <select name="<?php echo $this->getId() ?>_export" id="<?php echo $this->getId() ?>_export" style="width:8em;">
            <?php foreach ($this->getExportTypes() as $_type): ?>
                <option value="<?php echo $_type->getUrl() ?>"><?php echo $_type->getLabel() ?></option>
            <?php endforeach; ?>
            </select>
            <?php echo $this->getExportButtonHtml() ?>
        </td>
    <?php endif; ?>
        <td class="filter-actions a-right">
            <?php echo $this->getMainButtonsHtml() ?>
        </td>
        </tr>
    </table>
<?php endif; ?>
<?php if($this->getMassactionBlock()->isAvailable()): ?>
<?php echo $this->getMassactionBlockHtml() ?>
<?php endif ?>
<div class="entry-edit-head">
    <h3><?php echo $this->__('Staging Merge Mapping Configuration'); ?></h3>
</div>
<form action="<?php echo $this->getSaveUrl() ?>" method="post" id="enterprise_staging_merge_form" enctype="multipart/form-data">
<input type="hidden" name="schedule_merge_later_flag" value="" id="schedule_merge_later_flag">
<?php echo $this->getBlockHtml('formkey')?>
<div id="<?php echo $this->getId() ?>" class="grid">
    <div class="hor-scroll">
    <table cellspacing="0" class="data" id="<?php echo $this->getId() ?>_table">
        <col />
        <col />
        <col width="200" />
        <thead>
            <tr class="headings">
                <th><?php echo $this->__('From'); ?></th>
                <th><?php echo $this->__('To'); ?></th>
                <th><?php echo $this->__('Action'); ?></th>
            </tr>
        </thead>
        <tbody id="<?php echo $this->getId() ?>_rows">
            <tr id="<?php echo $this->getId() ?>_website_template" style="display: none;">
                <td class="mapper-name"><?php echo $this->__('Staging Website: '); ?>&nbsp;&nbsp;&nbsp;
                    <select name="map[websites][from][]" class="validate-select-website staging-mapper-website-from">
                        <option value=""><?php echo $this->__('Select website from map'); ?></option>
                    <?php foreach ($stagingWebsites as $website): ?>
                        <?php $slaveWebsite = $website->getSlaveWebsite(); ?>
                        <option value="<?php echo $slaveWebsite->getId(); ?>"><?php echo $slaveWebsite->getName(); ?></option>
                    <?php endforeach; ?>
                    </select>
                </td>
                <td class="mapper-select"><?php echo $this->__('Website: '); ?>&nbsp;&nbsp;&nbsp;
                    <select name="map[websites][to][]" class="validate-select-website staging-mapper-website-to">
                        <option value=""><?php echo $this->__('Select website to map'); ?></option>
                    <?php foreach ($masterWebsites as $website): ?>
                        <option value="<?php echo $website->getId(); ?>"><?php echo $website->getName(); ?></option>
                    <?php endforeach; ?>
                    </select>
                </td>
                <td>
                    <button class="button" onclick="<?php echo $this->getJsObjectName() ?>.removeWebsiteMap(this); return false;"><span><?php echo $this->__('Remove'); ?></span></button>
                </td>
            </tr>
            <tr id="<?php echo $this->getId() ?>_store_template" style="display: none;">
                <td class="mapper-name">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php echo $this->__('Staging Store: '); ?>&nbsp;&nbsp;&nbsp;
                    {{store_from_select}}
                </td>
                <td class="mapper-select">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?php echo $this->__('Store: '); ?>&nbsp;&nbsp;&nbsp;
                    {{store_to_select}}
                </td>
                <td><button class="button" onclick="<?php echo $this->getJsObjectName() ?>.removeStoreMap(this); return false;"><span><?php echo $this->__('Remove'); ?></span></button></td>
            </tr>
            <tr id="<?php echo $this->getId() ?>_store_add_btn_template" style="display: none;">
                <td></td>
                <td></td>
                <td>
                    <button class="staging-mapper-add-store-btn button disabled" disabled="disabled" onclick="<?php echo $this->getJsObjectName() ?>.addStoreMap(this); return false;"><span><?php echo $this->__('Add new store view map'); ?></span></button>
                </td>
            </tr>
        </tbody>
        <tfoot>
            <tr class="staging-mapper-add-website-row">
                <td></td>
                <td align="right" colspan="2">
                    <button class="staging-mapper-add-website-btn button"" onclick="<?php echo $this->getJsObjectName() ?>.addWebsiteMap(); return false;"><span><?php echo $this->__('Add new website map'); ?></span></button>
                </td>
            </tr>
        </tfoot>
    </table>
    </div>
</div>
<div class="entry-edit">
    <div id="staging_merge_additional_config" class="fieldset">
        <table class="form-list" cellspacing="0">
            <tr>
                <td class="label"><label for="staging_merge_backup_flag"><?php echo $this->__('Create a backup') ?></label></td>
                <td class="value"><input type="checkbox" checked="checked" value="1" name="map[backup]" id="staging_merge_backup_flag" /></td>
            </tr>
        </table>
    </div>
</div>
<h3><?php echo $this->__('Items to merge'); ?></h3>
<?php echo $this->getChildHtml('items'); ?>

<div id="schedule_config_container" style="background: #E5ECF2; border:2px solid #D6D6D6; width: 300px; height: 300px; display: none; left:40%; margin-left:-60px; padding:35px 35px; position:fixed; top:30%;">
    <div class="entry-edit">
        <div class="entry-edit-head">
            <h4 class="icon-head head-edit-form fieldset-legend"><?php echo $this->__('Merge Now') ?></h4>
        </div>
        <div class="fieldset">
            <div class="hor-scroll">
                <div class="a-center">
                    <button onclick="<?php echo $this->getJsObjectName() ?>.stagingMerge(); return false;" class="staging-mapper-add-website-btn button">
                        <span><?php echo $this->__('Merge') ?></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="entry-edit">
        <div class="entry-edit-head">
            <h4 class="icon-head head-edit-form fieldset-legend"><?php echo $this->__('Schedule Merge Date') ?></h4>
        </div>
        <div class="fieldset">
            <div class="hor-scroll">
                <div>
                    <label for="schedule_merge_later">Set Staging Merge Date</label>
                    <input type="text" style="width: 100px;" class="schedule_merge_later input-text" title="Set Staging Merge Date" value="" id="schedule_merge_later" name="schedule_merge_later"/> <img style="" title="Select Date" id="schedule_merge_later_trig" class="v-middle" alt="" src="<?php echo $this->getSkinUrl("images/grid-cal.gif");?> "/>
                    <script type="text/javascript">
                    //<![CDATA[
                        Calendar.setup({
                            inputField: "schedule_merge_later",
                            ifFormat: "%m/%e/%Y",
                            showsTime: true,
                            button: "schedule_merge_later_trig",
                            align: "Bl",
                            singleClick : true
                        });
                    //]]>
                    </script>
                </div>
                <br />
                <div class="a-center">
                    <button onclick="<?php echo $this->getJsObjectName() ?>.stagingMerge( {merge_later: 1} ); return false;" class="staging-mapper-add-website-btn button">
                        <span><?php echo $this->__('Merge later') ?></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="entry-edit">
        <div class="entry-edit-head">
            <h4 class="icon-head head-edit-form fieldset-legend"><?php echo $this->__('Cancel Merge') ?></h4>
        </div>
        <div class="fieldset">
            <div class="hor-scroll">
                <div class="a-center">
                    <button onclick="<?php echo $this->getJsObjectName() ?>.cancelMerge(); return false;" class="staging-mapper-add-website-btn button">
                        <span><?php echo $this->__('Cancel') ?></span>
                    </button>
                </div>
                <br />
            </div>
        </div>
    </div>
</div>
</form>
<script type="text/javascript">
//<![CDATA[
<?php echo $this->getJsObjectName() ?> = new Enterprise.Staging.Mapper('<?php echo $this->getId() ?>', '<?php echo $this->getGridUrl() ?>', '<?php echo $this->getVarNamePage() ?>', '<?php echo $this->getVarNameSort() ?>', '<?php echo $this->getVarNameDir() ?>', '<?php echo $this->getVarNameFilter() ?>', 'enterprise_staging_merge_form', <?php echo $this->getAllStoresJson(); ?>);
var stagingGrid = <?php echo $this->getJsObjectName() ?>.grid;
stagingGrid.useAjax = '<?php echo $this->getUseAjax() ?>';
<?php if ($this->getRowClickCallback()): ?>
stagingGrid.rowClickCallback = <?php echo $this->getRowClickCallback() ?>;
<?php endif; ?>
<?php if ($this->getCheckboxCheckCallback()): ?>
stagingGrid.checkboxCheckCallback = <?php echo $this->getCheckboxCheckCallback() ?>;
<?php endif; ?>
<?php if ($this->getRowInitCallback()): ?>
stagingGrid.initRowCallback = <?php echo $this->getRowInitCallback() ?>;
stagingGrid.rows.each(function(row){<?php echo $this->getRowInitCallback() ?>(stagingGrid, row)});
<?php endif; ?>

Validation.addAllThese([
    ['schedule_merge_later', '<?php echo Mage::helper('catalog')->__('Please set up merge date .') ?>', function(v) {
                if ($('schedule_merge_later_flag').value == 1) {
                    var mergeDate   = new Date(v);
                    var currentTime  = new Date();
                    if (v == '' || ((currentTime.getTime()+3600) >= mergeDate.getTime())) {
                        return false;
                    }
                }
                return true;
            }],
            
    ['validate-select-website', 'Please select website', function(v, elem) {
                if (elem.parentNode.parentNode.style.display != 'none') {
                    return ((v != "none") && (v != null) && (v.length != 0));
                }
                return true;
            }],
    ['validate-select-store', 'Please select store view', function(v, elem) {
                if (elem.parentNode.parentNode.style.display != 'none') {
                    return ((v != "none") && (v != null) && (v.length != 0));
                }
                return true;
            }]]);
            
            
//]]>            
</script>