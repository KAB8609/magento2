<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category   design
 * @package    default_default
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://www.magentocommerce.com/license/enterprise-edition
 */
?>
<?php
/**
 * @see Enterprise_Permissions_Block_Permissions_Tab_Rolesedit_Websites
 */
?>

<div class="entry-edit">
    <div class="entry-edit-head">
        <h4 class="icon-head head-edit-form fieldset-legend"><?php echo $this->__('Websites') ?></h4>
    </div>
    <fieldset>

        <span class="field-row">
            <label for="all_websites"><?php echo $this->__('Websites / Stores') ?></label>
            <select id="all_websites" name="permissions_is_all_sites" onchange="$('websites_container').toggle()" class="select">
                <option value="0"><?php echo $this->__('Custom') ?></option>
                <option value="1" <?php echo ($this->getIsEverythingAllowed() ? 'selected' : '') ?>><?php echo $this->__('All') ?></option>
            </select>
        </span>

        <div id="websites_container">
            <ul>
            <?php foreach ($this->getWebsites() as $websiteId => $website): ?>
                <li>
                <input class="permissions_website" type="checkbox" name="website_ids[]" value="<?php echo $websiteId ?>" id="permissions_website_<?php echo $websiteId ?>" <?php echo (in_array($websiteId, $this->getRole()->getWebsiteIds()) ? 'checked="checked" ' : '') ?>/><label for="permissions_website_<?php echo $websiteId ?>">
                    <?php echo $website->getName() ?>
                </label>
                <?php if (count($website->getGroups())): ?>
                    <ul id="permissions_website_<?php echo $websiteId ?>_groups" style="margin-left:1.5em">
                    <?php foreach ($website->getGroups() as $group): ?>
                        <li>
                        <input class="permissions_store_group" type="checkbox" name="store_group_ids[]" value="<?php echo $group->getId() ?>" id="permissions_store_group_<?php echo $group->getId() ?>" <?php echo (in_array($group->getId(), $this->getRole()->getStoreGroupIds()) ? 'checked="checked" ' : '') ?>/><label for="permissions_store_group_<?php echo $group->getId() ?>">
                            <?php echo $group->getName() ?>
                        </label>
                        </li>
                    <?php endforeach;?>
                    </ul>
                <?php endif; ?>
                </li>
            <?php endforeach;?>
            </ul>
        </div>
        <?php if ($this->getIsEverythingAllowed()):?>
        <script type="text/javascript">
            $('websites_container').toggle();
        </script>
        <?php endif;?>
        <script type="text/javascript">
        var roleWebsitesController = Class.create();
        roleWebsitesController.prototype = {
            initialize : function() {
                this.websites = [];
                $('websites_container').select('input.permissions_website').each(function(website) {
                    this.websites.push(website);
                    Event.observe(website, 'click', this.isWebsiteChecked.bind(this));
                    $(website.id + '_groups').select('input').each(function(storeInput) {
                        storeInput.__website = this;
                    }.bind(website));
                }.bind(this));

                this.stores = [];
                $('websites_container').select('input.permissions_store_group').each(function(store) {
                    this.stores.push(store);
                }.bind(this));
            },

            isWebsiteChecked : function() {
                // disable checkboxes of all stores if any of a website is checked
                for (var k = 0; k < this.websites.length; k++) {
                    if (this.websites[k].checked) {
                        this.disableStores(true);
                        return true;
                    }
                }
                // enable checkboxes of all stores if all of websites are not checked
                this.disableStores(false);
                return false;
            },

            disableStores : function(isDisabled) {
                for (var k = 0; k < this.stores.length; k++) {
                    var storeCheckbox = this.stores[k];
                    storeCheckbox.disabled = isDisabled;
//                    if (isDisabled) {
                        storeCheckbox.checked = storeCheckbox.__website.checked;
//                    }
                }
            }
        }

        rwc = new roleWebsitesController();
        rwc.isWebsiteChecked();
        </script>
    </fieldset>
</div>
