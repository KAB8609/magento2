<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design_default
 * @package     Mage_Downloadable
 * @copyright   Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * @see Mage_Downloadable_Block_Adminhtml_Catalog_Product_Edit_Tab_Downloadable_Samples
 */
?>

<?php $_product = $this->getProduct() ?>
<div class="fieldset">
    <table cellspacing="0" class="form-list">
        <tbody>
            <tr class="headings">
                <td class="label"><label for="name"><?php echo Mage::helper('downloadable')->__('Title')?></label>
                </td>
                <td class="value">
                    <input type="text" class="input-text" name="product[samples_title]" value="<?php echo $_product->getId()?$_product->getSamplesTitle():$this->getSamplesTitle() ?>" <?php echo ($_product->getStoreId() && $this->getUsedDefault())?'disabled="disabled"':'' ?> />
                </td>
                <td class="scope-label"><?php if (!Mage::app()->isSingleStoreMode()): ?>[STORE VIEW]<?php endif; ?></td>
                <td class="value use-default">
                <?php if($_product->getStoreId()): ?>
                    <input id="sample_title_default" type="checkbox" name="use_default[]" value="samples_title" onclick="toggleValueElements(this, this.parentNode.parentNode)" <?php echo $this->getUsedDefault()?'checked="checked"':'' ?> />
                    <label class="normal" for="sample_title_default">Use Default Value</label>
                <?php endif; ?>
                </td>
            </tr>
        </tbody>
    </table>
    <br />
    <div class="grid">
        <div class="hor-scroll">
            <table cellspacing="0" class="data">
                <col />
                <col width="420" />
                <col width="1" />
                <col width="1" />
                <thead>
                    <tr class="headings">
                        <th><?php echo Mage::helper('downloadable')->__('Title') ?> <span class="required">*</span></th>
                        <th><?php echo Mage::helper('downloadable')->__('File') ?></th>
                        <th><span class="nobr"><?php echo Mage::helper('downloadable')->__('Sort Order') ?></span></th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <td colspan="4" class="a-right"><?php echo $this->getAddButtonHtml() ?></td>
                    </tr>
                </tfoot>
                <tbody id="sample_items_body">
                </tbody>
            </table>
        </div>
    </div>
</div>
<input type="hidden" id="<?php echo $this->getHtmlId() ?>_save" name="downloadable[sample][100][file]" value="<?php echo $this->htmlEscape($this->getFilesJson()) ?>" />
<script type="text/javascript">
//<![CDATA[>
var sampleTemplate = '<tr>' +
                        '<td>' +
                            '<input type="hidden" class="__delete__" name="downloadable[sample][{{id}}][is_delete]" value="" />' +
                            '<input type="hidden" name="downloadable[sample][{{id}}][sample_id]" value="{{sample_id}}" />' +
                            '<input type="text" class="required-entry input-text" name="downloadable[sample][{{id}}][title]" value="{{title}}" />' +
                            '<?php echo $_product->getStoreId()?'<br /><input type="checkbox" id="downloadable_sample_{{id}}_title" name="downloadable[sample][{{id}}][use_default_title]" value="1" /><label class="normal" for="downloadable_sample_{{id}}_title">Use Default Value</label>':'' ?>'+
                        '</td>' +
                        '<td class="files files-wide" id="<?php echo $this->getHtmlId() ?>_files_browser">' +
                            '<!--<p><label><input type="radio" class="radio validate-one-required-by-name" id="downloadable_sample_{{id}}_file" name="downloadable[sample][{{id}}][sample_type]" value="file" /> File:</label> <input type="file" size="43" name="downloadable[sample][{{id}}][sample_file]" value="" class="validate-downloadable-file input-file" /></p>-->' +
                            '<p><label><input type="radio" class="radio validate-one-required-by-name" id="downloadable_sample_{{id}}_url" name="downloadable[sample][{{id}}][sample_type]" value="url" /> URL:</label> <input type="text" class="validate-downloadable-url input-text" name="downloadable[sample][{{id}}][sample_url]" value="{{sample_url}}" /></p>' +
                            '<p><span id="downloadable_sample_{{id}}_container"></span></p>' +
                        '</td>' +
                        '<td class="a-center"><input type="text" name="downloadable[sample][{{id}}][sort_order]" value="{{sort_order}}" class="input-text sort" /></td>' +
                        '<td>' +
                            '<button type="button" class="scalable delete icon-btn delete-sample-item"><span>Delete</span></button>' +
                        '</td>' +
                    '</tr>';
var uploaderTemplate = '<div id="<?php echo $this->getHtmlId() ?>" class="uploader">'+
                                '<div class="buttons">'+
                                    '<div id="<?php echo $this->getHtmlId() ?>-install-flash" style="display:none">'+
                                        '<?php echo Mage::helper('media')->__('This content requires last version of Adobe Flash Player. <a href="%s">Get Flash</a>', 'http://www.adobe.com/go/getflash/') ?>'+
                                    '</div>'+
                                '</div>'+
                                '<div class="clear"></div>'+
                                '<div class="no-display" id="<?php echo $this->getHtmlId() ?>-template">'+
                                    '<div id="{{id}}" class="file-row">'+
                                        '<span class="file-info">{{name}} ({{size}})</span>'+
                                        '<span class="delete-button"><button id="{{id}}-delete" type="button" class="scalable delete" onclick="<?php echo $this->getJsObjectName() ?>.removeFile(\'{{fileId}}\')" style=""><span>Remove</span></button></span>'+
                                        '<span class="progress-text"></span>'+
                                        '<div class="clear"></div>'+
                                    '</div>'+
                                '</div>'+
                                '<div class="no-display" id="<?php echo $this->getHtmlId() ?>-template-progress">'+
                                    '{{percent}}% {{uploaded}} / {{total}}'+
                                '</div>'+
                            '</div>';

var sampleItems = {
    tbody : $('sample_items_body'),
    templateSyntax : /(^|.|\r|\n)({{(\w+)}})/,
    templateText : sampleTemplate,
    uploaderText: uploaderTemplate,
    itemCount : 0,
    add : function(data) {
        this.template = new Template(this.templateText, this.templateSyntax);

        if(!data.sample_id){
            data = {};
            data.sample_id  = 0;
        }
        data.id = this.itemCount;
        Element.insert(this.tbody, {'bottom':this.template.evaluate(data)});

        scopeTitle = $('downloadable_sample_'+data.id+'_title');
        if (scopeTitle) {
        	Event.observe(scopeTitle, 'click', function(event){
                scopeElm = $(Event.findElement(event, 'input'));
                titleField = scopeElm.up(0).down('input[type="text"]');
                if (titleField.disabled == true) {
                    titleField.disabled = false;
                } else {
                    titleField.disabled = true;
                }
            });
        }
        if (!data.store_title && scopeTitle) {
        	scopeTitle.up(0).down('input[type="text"]').disabled = true;
            scopeTitle.checked = true;
        }

        sampleUrl = $('downloadable_sample_'+data.id+'_url');
        sampleUrl.advaiceContainer = 'downloadable_sample_'+data.id+'_container';
        if (data.sample_type == 'url') {
            sampleUrl.checked = true;
        } else if (data.sample_type == 'file') {
            sampleFile.checked = true;
        }

        Element.insert(
            sampleUrl.up('td'),
            {'top' : this.uploaderText}
        );

        new Flex.Uploader('<?php echo $this->getHtmlId() ?>', '<?php echo $this->getSkinUrl('media/uploader.swf') ?>', <?php echo $this->getConfigJson() ?>);

        this.itemCount++;
        this.bindRemoveButtons();
    },
    remove : function(event){
        var element = $(Event.findElement(event, 'tr'));
        if(element){
            element.down('input[type="hidden"].__delete__').value = '1';
            element.addClassName('no-display');
            element.addClassName('ignore-validate');
            element.hide();
        }
    },
    bindRemoveButtons : function(){
        var buttons = $$('tbody#sample_items_body .delete-sample-item');
        for(var i=0;i<buttons.length;i++){
            if(!$(buttons[i]).binded){
                $(buttons[i]).binded = true;
                Event.observe(buttons[i], 'click', this.remove.bind(this));
            }
        }
    }
}

sampleItems.bindRemoveButtons();

if($('add_sample_item')){
    Event.observe('add_sample_item', 'click', sampleItems.add.bind(sampleItems));
}

<?php foreach ($this->getSampleData() as $item): ?>
    sampleItems.add(<?php echo $item->toJson() ?>);
<?php endforeach; ?>


var <?php echo $this->getJsObjectName() ?> = new Flex.Uploader('<?php echo $this->getHtmlId() ?>', '<?php echo $this->getSkinUrl('media/uploader.swf') ?>', <?php echo $this->getConfigJson() ?>);

var <?php echo $this->getJsObjectName('uploaded'); ?> = new Downloadable.Files('<?php echo $this->getHtmlId() ?>', <?php echo $this->getJsObjectName() ?>, {});
//]]>
</script>