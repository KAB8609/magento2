<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is bundled with this package in the file LICENSE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * @category   design_default
 * @package    Mage
 * @copyright  Copyright (c) 2008 Irubin Consulting Inc. DBA Varien (http://www.varien.com)
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
?>
<div class="content-header left-col-block">
    <table cellspacing="0">
        <tr>
            <td><h3 class="icon-head head-categories"><?php echo Mage::helper('catalog')->__('Categories') ?></h3></td>
            <td class="form-buttons">
                <?php if ($this->getRoot()): ?>
                    <?php echo $this->getAddButtonHtml() ?>
                <?php endif; ?>
            </td>
        </tr>
    </table>
</div>
<?php echo $this->getStoreSwitcherHtml() ?>
<div>
    <table cellspacing="0">
        <tr>
            <td class="form-buttons">
                <?php if($this->getRoot()): ?>
                    <?php echo $this->getCollapseButtonHtml() ?>
                <?php endif; ?>
            </td>
            <td class="form-buttons">
                <?php if($this->getRoot()): ?>
                    <?php echo $this->getExpandButtonHtml() ?>
                <?php endif; ?>
            </td>
        </tr>
    </table>
</div>
<?php if ($this->getRoot()): ?>
<div style="margin-right:10px;">
<div id="tree-div" style="width:100%;overflow:auto;"></div>
</div>
<script type="text/javascript">
var tree;
var root;
var categoryLoader;

Ext.tree.TreePanel.prototype._switchTree = function(transport)
{
    var response = eval('('+transport.responseText+')');
    if (!response['parameters']) {
        return false;
    }

    tree.reloadTree(response['parameters'],response['data']);
}

Ext.tree.TreePanel.prototype.switchTree = function(url, params)
{
    new Ajax.Request(
        url + (url.match(new RegExp('\\?')) ? '&ajax=true' : '?ajax=true' ),
        {
           parameters:  params || {},
           method:      'post',
           onComplete:  tree._switchTree.bind(this)
        }
    );
}

Ext.tree.TreePanel.prototype.switchStore = function(event, switcher)
{
    var obj = event.target;

    var storeParam = obj.value ? 'store/'+obj.value + '/' : '';

    if (obj.switchParams) {
        storeParam+= obj.switchParams;
    }
    if (switcher.useConfirm) {
        if (!confirm("<?php echo $this->__('Please confirm site switching. All data that hasn\'t been saved will be lost.') ?>")){
            obj.value = '<?php echo $this->getStoreId() ?>';
            return false;
        }
    }

    if (this.useAjax && this.storeId != obj.value) {
        if (this.cache[this.storeId]) {
            this.cache[this.storeId]['parameters']['category_id'] = this.currentNodeId;
        }
        this.el.dom.innerHTML = '';
        this.unregisterNode(this.root);
        this.storeId = obj.value;

        var cache = this.cache[this.storeId];

        if (cache) {
            storeParam = storeParam+'id/'+cache['parameters']['category_id']+'/';
            this.reloadTree(cache['parameters'],cache['data'],true);
        } else {
            this.switchTree(this.switchTreeUrl+storeParam, {store:this.storeId});
        }
    }

    this.updateContent(this.switchEditUrl+storeParam);
}

Ext.tree.TreePanel.prototype.updateContent = function(url, params)
{
    if (!this.useAjax) {
        setLocation(url);
        return;
    }

    if (!params) {
        var params = {active_tab_id:category_info_tabsJsTabs.activeTab.id};
    }

    new Ajax.Updater(
        this.categoryContainer,
        url + (url.match(new RegExp('\\?')) ? '&ajax=true' : '?ajax=true' ),
        {
           parameters:  params || {},
           method:      'post',
           loaderArea:  this.categoryContainer,
           onComplete:  refreshEditArea.bind(this),
           evalScripts: true
        }
    );
}

Ext.tree.TreePanel.prototype.request = function(url, params)
{
    if (!params) {
        var params = {active_tab_id:category_info_tabsJsTabs.activeTab.id};
    }
    var result = new Ajax.Request(
        url + (url.match(new RegExp('\\?')) ? '&ajax=true' : '?ajax=true' ),
        {
           parameters:  params || {},
           method:      'post',
           loaderArea:  this.categoryContainer
        }
    );

    return result;
}

Ext.EventManager.onDocumentReady(function() {

    categoryLoader = new Ext.tree.TreeLoader({
       dataUrl: '<?php echo $this->getLoadTreeUrl() ?>'
    });

    categoryLoader.createNode = function(config) {
        var node;
        if (config.children && !config.children.length) {
            delete(config.children);
            node = new Ext.tree.AsyncTreeNode(config);

        } else {
            node = new Ext.tree.TreeNode(config);
        }
        return node;
    };

    categoryLoader.on("beforeload", function(treeLoader, node) {
        treeLoader.baseParams.id = node.attributes.id;
    });

    categoryLoader.on("load", function(treeLoader, node, config) {
        varienWindowOnload();
    });

    tree = new Ext.tree.TreePanel('tree-div', {
        animate:          false,
        loader:           categoryLoader,
        enableDD:         true,
        containerScroll:  true,
		selModel:         new Ext.tree.CheckNodeMultiSelectionModel(),
		rootVisible:      '<?php echo $this->getRoot()->getIsVisible() ?>',
		useAjax:          <?php echo $this->getUseAjax() ?>,
		switchTreeUrl:    '<?php echo $this->getSwitchTreeUrl() ?>',
		switchEditUrl:          '<?php echo $this->getSwitchedEditUrl() ?>',
		categoryContainer:$('content').getElementsBySelector('.main-col-inner')[0],
		storeId:          <?php echo (int) $this->getStore()->getId() ?>,
		currentNodeId:    <?php echo (int) $this->getCategoryId() ?>,
		cache:            {}
	});
    tree.storeId = <?php echo (int) $this->getStore()->getId() ?>;

	varienStoreSwitcher.storeSelectorClickCallback = tree.switchStore.bind(tree);

	// set the root node
	var parameters = {
        text:       '<?php echo htmlentities($this->getRoot()->getName()) ?>',
        draggable:  false,
        allowDrop:  <?php if ($this->getRoot()->getIsVisible()): ?>true<?php else : ?>false<?php endif; ?>,
        id:         <?php echo (int) $this->getRoot()->getId() ?>,
        expanded:   <?php echo (int) $this->getIsWasExpanded() ?>,
        store_id:   <?php echo (int) $this->getStore()->getId() ?>,
        category_id:<?php echo (int) $this->getCategoryId() ?>
    };

    tree.reloadTree(parameters,<?php echo $this->getTreeJson() ?>);

});

Ext.tree.TreePanel.prototype.reloadTree = function(parameters, data, alreadyLoaded)
{
	tree.cache[parameters['store_id']] = {parameters:parameters,data:data};

    root = new Ext.tree.TreeNode(parameters);

    this.setRootNode(root);

    buildCategoryTree(root, data);

    if (!alreadyLoaded) {
        this.addListener('click', categoryClick.createDelegate(this));
        this.addListener('beforenodedrop', categoryMove.createDelegate(this));
    }

    // render the tree
    this.render();
    if (parameters['expanded']) {
        this.expandAll();
    } else {
        root.expand();
    }

    var selectedNode = tree.getNodeById(parameters['category_id']);
    if(selectedNode){
        tree.getSelectionModel().select(selectedNode);
    }
}

function addNew(url)
{
    tree.updateContent(url);
}

function categorySubmit()
{
    var activeTab = document.createElement('INPUT');
    activeTab.type= 'hidden';
    activeTab.name= 'active_tab_id';
    activeTab.value = category_info_tabsJsTabs.activeTab.id;
    categoryForm.validator.form.appendChild(activeTab);

    categoryForm.submit();
}

function categoryReset(url, params)
{
    var params = {active_tab_id:false};
    tree.updateContent(url, params);
}

function categoryDelete(url)
{
    tree.updateContent(url);
}

function refreshEditArea(transport)
{
    setTimeout(function() {
        category_info_tabsJsTabs.moveTabContentInDest();
    }, 500);
}

function categoryAdd(id)
{
    var ids = $('product_categories').value.split(',');
    ids.push(id);
    $('product_categories').value = ids.join(',');
}

function categoryRemove(id)
{
    var ids = $('product_categories').value.split(',');
    ids.splice(ids.indexOf(id), 1);
    $('product_categories').value = ids.join(',');
}

function collapseTree()
{
    categoryLoader.dataUrl = '<?php echo $this->getLoadTreeUrl(false) ?>';
    tree.request(categoryLoader.dataUrl);
    tree.collapseAll();
}

function expandTree()
{
    categoryLoader.dataUrl = '<?php echo $this->getLoadTreeUrl(true) ?>';
    tree.expandAll();
}

function buildCategoryTree(parent, config)
{
    if (!config) return null;

	if (parent && config && config.length){
        for (var i = 0; i < config.length; i++) {
            var node = new Ext.tree.TreeNode(config[i]);
            if (config[i].children && !config[i].children.length) {
                delete(config[i].children);
                node = new Ext.tree.AsyncTreeNode(config[i]);
            } else {
                node = new Ext.tree.TreeNode(config[i]);
            }
            parent.appendChild(node);
            node.loader = node.getOwnerTree().loader;
            if (config[i].children) {
                buildCategoryTree(node, config[i].children);
            }
        }
    }
}

function categoryClick(node, e)
{
    var url = '<?php echo $this->getEditUrl() ?>'+'store/'+tree.storeId+'/'+'id/'+node.id+'/';
    tree.currentNodeId = node.id;
    new Ajax.Updater(
        tree.categoryContainer,
        url + (url.match(new RegExp('\\?')) ? '&ajax=true' : '?ajax=true' ),
        {
           parameters: {
               active_tab_id: category_info_tabsJsTabs.activeTab.id
           },
           method:      'post',
           loaderArea:  tree.categoryContainer,
           onComplete:  refreshEditArea.bind(this),
           evalScripts: true
        }
    );
}

function categoryMove(obj)
{
    var data = {id: obj.dropNode.id}

    data.point = obj.point;
    switch (obj.point) {
        case 'above' :
            data.pid = obj.target.parentNode.id;
            data.paid = obj.dropNode.parentNode.id;
            if (obj.target.previousSibling) {
                data.aid = obj.target.previousSibling.id;
            } else {
                data.aid = 0;
            }
            break;
        case 'below' :
            data.pid = obj.target.parentNode.id;
            data.aid = obj.target.id;
        break;
        case 'append' :
            data.pid = obj.target.id;
            data.paid = obj.dropNode.parentNode.id;
            if (obj.target.lastChild) {
                data.aid = obj.target.lastChild.id;
            } else {
                data.aid = 0;
            }
        break;
        default :
            obj.cancel = true;
            return obj;
    }

    var success = function(o) {
        try {
            if(o.responseText && o.responseText!=='SUCCESS'){
                alert(o.responseText);
                location.reload();
            }
        }
        catch(e) {

        }
    };
    var failure = function(o) {
        if (console) {
            console.log(o.statusText);
        } else {
            alert(o.statusText);
        }
        location.reload();
    };

    var pd = [];
    for(var key in data) {
        pd.push(encodeURIComponent(key), "=", encodeURIComponent(data[key]), "&");
    }
    pd.splice(pd.length-1,1);
    new Ajax.Request(
        '<?php echo $this->getMoveUrl() ?>',
        {
            method:     'POST',
            parameters: pd.join(""),
            onSuccess : success,
            onFailure : failure,
//            loaderArea: 'tree-div'
        }
    );
}
</script>
<?php endif; ?>