<?if($this->getItems()->getSize()):?>
<div class="box base-mini related-items"> 
    <div class="head">
        <span class="corner"></span>
        <h3><?=__('Related')?></h3>
    </div>
    <div class="box-container">
        <div class="content">
            <p><strong>Check items to add to cart or <a href="#" onclick="selectAllRelated();return false;">select all</a>.</strong></p>
            <ol>
            <?foreach($this->getItems() as $_item):?>
            <li>
                <div class="product-images">
                    <input type="checkbox" class="related-checkbox left" id="related-checkbox<?=$_item->getId()?>" name="related_products[]" value="<?=$_item->getId()?>"/> 
                    <a href="<?=$_item->getProductUrl()?>"><img src="<?=$_item->getThumbnailUrl()?>" alt="<?=$_item->getName()?>" width="32" height="32"/></a>
                </div>
                <div class="product-details">
                    <p>
                        <a href="<?=$_item->getProductUrl()?>"><?=$_item->getName()?></a><br/>
                        <?=$this->getHelper('catalog/product')->getPriceHtml($_item)?>
                        <a href="<?=$this->getAddToCartUrl($_item)?>">Add to Cart</a><br/>
                        <a href="<?=$this->getAddToWishlistUrl($_item)?>">Add to Wishlist</a>
                    </p>
                </div>
            </li>
            <?endforeach?>
            </ol>
        </div>
    </div>
</div>
<script type="text/javascript">
$$('.related-checkbox').each(function(elem){
    Event.observe(elem, 'click', addRelatedToProduct)
});

function selectAllRelated(){
    $$('.related-checkbox').each(function(elem){
        elem.checked = true;
    });
    addRelatedToProduct();
}

function addRelatedToProduct(){
    var checkboxes = $$('.related-checkbox');
    var values = [];
    for(var i=0;i<checkboxes.length;i++){
        if(checkboxes[i].checked) values.push(checkboxes[i].value);
    }
    if($('related-products-field')){
        $('related-products-field').value = values.join(',');
    }
}
</script>
<?endif?>