<?xml version="1.0" encoding="utf-8"?>
<!--
/**
 * {license_notice}
 *
 * @category   dev
 * @package    build
 * @copyright  {copyright}
 * @license    {license_link}
 */
-->
<project name="Magento2" basedir="../../" default="init">
    <property environment="env"/>
    <property name="file.phpunit_xdebug" location="dev/build/bin/phpunit-with-xdebug.sh"/>

    <!-- copy the build customization files -->
    <target name="init" if="env.build_customization_dir">
        <copy todir="${basedir}" failonerror="true" overwrite="true">
            <fileset dir="${basedir}/${env.build_customization_dir}"/>
        </copy>
    </target>

    <!-- make script, that runs phpunit with xdebug enabled, executable -->
    <target name="prepare-xdebug">
        <chmod perm="u+x" file="${file.phpunit_xdebug}"/>
    </target>

    <!-- setup permissions for the application installation -->
    <target name="prepare-installation">
        <chmod perm="a+w">
            <dirset dir="${basedir}/app/etc"/>
            <dirset dir="${basedir}/pub/media"/>
            <fileset dir="${basedir}/pub/media"/>
            <dirset dir="${basedir}/var"/>
        </chmod>
    </target>

    <!-- delete files, that don't belong to Community Edition, from working copy -->
    <target name="prepare-ce">
        <property name="dir.extruder" location="${basedir}/dev/build/publication/extruder"/>
        <exec executable="php" failonerror="true">
            <arg line="-f ${dir.extruder}/extruder.php --
                -w ${basedir}
                -l ${dir.extruder}/common.txt
                -l ${dir.extruder}/ce.txt
                -v
                "/>
        </exec>
    </target>

    <!-- execute extruder, perform license notices replacement and sanity check -->
    <target name="sanity-ce" depends="prepare-ce">
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/license/license-tool.php --
                -w ${basedir} -e ce -v"/>
        </exec>
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/sanity/sanity.php --
                -w ${basedir} -c ${basedir}/dev/build/publication/sanity/ce.xml -v"/>
        </exec>
    </target>

    <!-- product unit tests -->
    <target name="unit-tests-magento">
        <exec dir="dev/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit-tests-magento.xml"/>
        </exec>
    </target>

    <!-- product unit tests with code coverage -->
    <target name="unit-tests-magento-coverage" depends="prepare-xdebug">
        <exec dir="dev/tests/unit" executable="${file.phpunit_xdebug}" failonerror="true">
            <arg line="--log-junit ${basedir}/unit-tests-magento-xdebug.xml
                --coverage-clover ${basedir}/unit-tests-magento-coverage.xml
                "/>
        </exec>
    </target>

    <!-- integration testing framework unit tests -->
    <target name="unit-tests-integration-framework">
        <exec dir="dev/tests/integration/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit-tests-integration-framework.xml"/>
        </exec>
    </target>

    <!-- static code analysis framework unit tests -->
    <target name="unit-tests-static-framework">
        <exec dir="dev/tests/static/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit-tests-static-framework.xml"/>
        </exec>
    </target>

    <!-- product integration tests -->
    <target name="integration-tests-magento" depends="init">
        <exec dir="dev/tests/integration" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/integration-tests-magento.xml"/>
        </exec>
    </target>

    <!-- product integration tests with xdebug -->
    <target name="integration-tests-magento-xdebug" depends="init,prepare-xdebug">
        <exec dir="dev/tests/integration" executable="${file.phpunit_xdebug}" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/integration-tests-magento-xdebug.xml"/>
        </exec>
    </target>

    <!-- product integration tests with code coverage report -->
    <target name="integration-tests-magento-coverage" depends="init,prepare-xdebug">
        <delete dir="${basedir}/coverage-html"/>
        <mkdir dir="${basedir}/coverage-html"/>
        <exec dir="dev/tests/integration" executable="${file.phpunit_xdebug}" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/integration-tests-magento-xdebug.xml
                --coverage-clover ${basedir}/integration-tests-magento-coverage.xml
                --coverage-html ${basedir}/integration-tests-magento-coverage
                "/>
        </exec>
    </target>

    <!-- all static tests -->
    <target name="static-tests-all">
        <exec dir="dev/tests/static" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/static-tests-all.xml"/>
        </exec>
    </target>

    <target name="functional-tests" description="Functional Tests" depends="init,prepare-installation">
        <condition property="useVmLauncher" value="false" else="true">
            <os family="windows"/>
        </condition>
        <exec dir="dev/tests/functional" executable="phpunit" vmlauncher="${useVmLauncher}" failonerror="true"/>
    </target>

    <!-- benchmark tests -->
    <target name="performance_tests" description="Performance Tests" depends="init,prepare-ce,prepare-installation">
        <exec executable="php" failonerror="true">
            <arg value="${basedir}/dev/tests/performance/run_scenarios.php"/>
        </exec>
    </target>

    <!-- deploy and run functional tests -->
    <target name="functional_tests_with_deploy" description="Deploy Magento">
        <fail unless="env.build_customization_dir" message="Bamboo variable 'customization_dir' must be defined" />
        <!-- Functional tests params -->
        <fail unless="env.deploy_directory" message="Bamboo variable 'deploy_directory' must be defined on your agent"/>
        <fail unless="env.db_host" message="Bamboo variable 'db_host' must be defined on your agent"/>
        <fail unless="env.db_name" message="Bamboo variable 'db_name' must be defined on your agent"/>
        <fail unless="env.db_user" message="Bamboo variable 'db_user' must be defined on your agent"/>
        <fail unless="env.db_password" message="Bamboo variable 'db_password' must be defined on your agent"/>
        <fail unless="env.http_host" message="Bamboo variable 'http_host' must be defined on your agent (e.g. http://myhost.com/mypath/)"/>
        <fail unless="env.https_host" message="Bamboo variable 'https_host' must be defined on your agent (e.g. https://myhost.com/mypath/)"/>

        <fail unless="env.selenium_host" message="Bamboo variable 'selenium_host' must be defined on your agent"/>
        <fail unless="env.selenium_port" message="Bamboo variable 'selenium_port' must be defined on your agent"/>
        <fail unless="env.testsuite" message="Bamboo variable 'testsuite' must be defined on your agent (mage, enterprise)"/>

        <property name="dir.build_directory" location="${env.deploy_directory}/${env.build.key}"/>

        <delete dir="${dir.build_directory}" />

        <copy todir="${dir.build_directory}" failonerror="true">
            <fileset dir="${basedir}"/>
        </copy>

        <copy todir="${dir.build_directory}" failonerror="true" overwrite="true">
            <fileset dir="${basedir}/${env.build_customization_dir}"/>
        </copy>

        <chmod perm="a+w">
            <dirset dir="${dir.build_directory}/app/etc"/>
            <dirset dir="${dir.build_directory}/pub/media"/>
            <fileset dir="${dir.build_directory}/pub/media"/>
            <dirset dir="${dir.build_directory}/var"/>
        </chmod>

        <replace file="${dir.build_directory}/dev/tests/functional/config/install.php"
                 token="{{db_host}}"
                 value="${env.db_host}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/install.php"
                 token="{{db_name}}"
                 value="${env.db_name}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/install.php"
                 token="{{db_user}}"
                 value="${env.db_user}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/install.php"
                 token="{{db_password}}"
                 value="${env.db_password}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/install.php"
                 token="{{url}}"
                 value="${env.http_host}${env.build.key}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/install.php"
                 token="{{secure_url}}"
                 value="${env.https_host}${env.build.key}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/config.yml"
                 token="{{admin_url}}"
                 value="${env.https_host}${env.build.key}/admin"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/config.yml"
                 token="{{url}}"
                 value="${env.http_host}${env.build.key}/"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/config.yml"
                 token="{{selenium_host}}"
                 value="${env.selenium_host}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/config.yml"
                 token="{{selenium_port}}"
                 value="${env.selenium_port}"/>

        <replace file="${dir.build_directory}/dev/tests/functional/config/config.yml"
                 token="{{selenium_testsuite}}"
                 value="${env.testsuite}"/>
    </target>

    <!-- Community Edition source code population to the public repository -->
    <target name="publish_ce">
        <property name="dir.publication_target" location="${basedir}/dev/build/publication/_tmp_target"/>
        <fail unless="env.bamboo_source_repository" message="Bamboo variable 'source_repository' must be defined."/>
        <fail unless="env.bamboo_target_repository" message="Bamboo variable 'target_repository' must be defined."/>
        <fail unless="env.bamboo_source_point" message="Bamboo variable 'source_point' must be defined."/>
        <condition property="env.bamboo_target_branch" value="master">
            <not><isset property="env.bamboo_target_branch"/></not>
        </condition>
        <delete dir="${dir.publication_target}" failonerror="true"/>
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/publish.php --
                --source=${env.bamboo_source_repository} --source-point=${env.bamboo_source_point}
                --target=${env.bamboo_target_repository} --target-branch=${env.bamboo_target_branch}
                --target-dir=${dir.publication_target}
                --changelog-file=CHANGELOG.markdown
                --no-push
                "/>
        </exec>
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/sanity/sanity.php --
                -w ${dir.publication_target}
                -c ${basedir}/dev/build/publication/sanity/ce.xml
                -v
                "/>
        </exec>
        <ant dir="${dir.publication_target}" antfile="../../build.xml" inheritAll="false">
            <property name="env.build_customization_dir" value="../../customization/publicce"/>
            <target name="unit-tests-magento"/>
            <target name="unit-tests-static-framework"/>
            <target name="unit-tests-integration-framework"/>
            <target name="static-tests-all"/>
            <target name="integration-tests-magento"/>
        </ant>
        <exec dir="${dir.publication_target}" executable="git" failonerror="true">
            <arg line="push origin ${env.bamboo_target_branch}"/>
        </exec>
    </target>

</project>
