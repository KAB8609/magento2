<?xml version="1.0" encoding="utf-8"?>
<project name="Magento2" basedir="../../" default="init">
    <property environment="env"/>
    <property name="file.phpunit_xdebug" location="dev/build/bin/phpunit-with-xdebug.sh"/>

    <!-- copy the build customization files -->
    <target name="init" if="env.build_customization_dir">
        <copy todir="${basedir}" failonerror="true">
            <fileset dir="${basedir}/${env.build_customization_dir}"/>
        </copy>
    </target>

    <!-- make script, that runs phpunit with xdebug enabled, executable -->
    <target name="prepare-xdebug">
        <exec executable="chmod" failonerror="true">
            <arg line="u+x ${file.phpunit_xdebug}"/>
        </exec>
    </target>

    <!-- delete files, that don't belong to Community Edition, from working copy -->
    <target name="prepare-ce">
        <property name="dir.extruder" location="${basedir}/dev/build/extruder"/>
        <exec executable="php" failonerror="true">
            <arg line="-f ${dir.extruder}/extruder.php -w ${basedir}
                -l ${dir.extruder}/common_tests.txt -l ${dir.extruder}/ce.txt -v -s git
                "/>
        </exec>
    </target>

    <!-- product unit tests -->
    <target name="unit-tests-magento">
        <exec dir="dev/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/unit-tests-magento.xml"/>
        </exec>
    </target>

    <!-- product unit tests with xdebug -->
    <target name="unit-tests-magento-xdebug" depends="prepare-xdebug">
        <exec dir="dev/tests/unit" executable="${file.phpunit_xdebug}" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/unit-tests-magento-xdebug.xml"/>
        </exec>
    </target>

    <!-- product unit tests with code coverage -->
    <target name="unit-tests-magento-coverage" depends="prepare-xdebug">
        <exec dir="dev/tests/unit" executable="${file.phpunit_xdebug}" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/unit-tests-magento-xdebug.xml
                --coverage-clover ${basedir}/unit-tests-magento-coverage.xml
                "/>
        </exec>
    </target>

    <!-- integration testing framework unit tests -->
    <target name="unit-tests-integration-framework">
        <exec dir="dev/tests/integration/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/unit-tests-integration-framework.xml"/>
        </exec>
    </target>

    <!-- static code analysis framework unit tests -->
    <target name="unit-tests-static-framework">
        <exec dir="dev/tests/static/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/unit-tests-static-framework.xml"/>
        </exec>
    </target>

    <!-- product integration tests -->
    <target name="integration-tests-magento" depends="init">
        <exec dir="dev/tests/integration" executable="phpunit" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/integration-tests-magento.xml"/>
        </exec>
    </target>

    <!-- product integration tests with xdebug -->
    <target name="integration-tests-magento-xdebug" depends="init,prepare-xdebug">
        <exec dir="dev/tests/integration" executable="${file.phpunit_xdebug}" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/integration-tests-magento-xdebug.xml"/>
        </exec>
    </target>

    <!-- product integration tests with code coverage report -->
    <target name="integration-tests-magento-coverage" depends="init,prepare-xdebug">
        <delete dir="${basedir}/coverage-html"/>
        <mkdir dir="${basedir}/coverage-html"/>
        <exec dir="dev/tests/integration" executable="${file.phpunit_xdebug}" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/integration-tests-magento-xdebug.xml
                --coverage-clover ${basedir}/integration-tests-magento-coverage.xml
                --coverage-html ${basedir}/integration-tests-magento-coverage
                "/>
        </exec>
    </target>

    <!-- all static tests -->
    <target name="static-tests-all">
        <exec dir="dev/tests/static" executable="phpunit" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/static-tests-all.xml"/>
        </exec>
    </target>

    <!-- benchmark tests -->
    <target name="performance_tests" description="Performance Tests" depends="init">
        <exec executable="chmod" failonerror="true">
            <arg line="a+w ${basedir}/var ${basedir}/pub/media"/>
        </exec>
        <exec executable="php" failonerror="true">
            <arg value="${basedir}/dev/build/performance.php"/>
        </exec>
    </target>
</project>
