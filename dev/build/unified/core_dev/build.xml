<?xml version="1.0" encoding="utf-8"?>
<!--
/**
 * Apache Ant's build file for unified "Core, Development" CI builds
 *
 * {license_notice}
 *
 * @category   dev
 * @package    build
 * @copyright  {copyright}
 * @license    {license_link}
 */
-->
<project name="Magento 2 Unified CI Builds" basedir="../../../../" default="_default">
    <property environment="env"/>

    <!--
    Targets prefixed with underscore are considered private and should not be used externally.
    All other targets are considered public and can be used in CI plans configuration and/or other build files.

    Note: Since CI plan/job/task configuration is shared between all configured branches, renaming underlying target
    will lead to CI build failure on branches, to which code changes are not merged yet.
    -->

    <target name="_default" description="Default target to be used when no target is supplied">
        <fail message="Target for Apache Ant build file must be specified"/>
    </target>


    <target name="_community_edition" description="Removal of files, which do not belong to Community Edition">
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/extruder/extruder.php --
                -w ${basedir}
                -l ${basedir}/dev/build/publication/extruder/common.txt
                -l ${basedir}/dev/build/publication/extruder/ce.txt
                -v
                "/>
        </exec>
    </target>


    <target name="_unit_tests_magento" description="Product unit tests">
        <exec dir="dev/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit_tests_magento.xml"/>
        </exec>
    </target>
    <target name="_unit_tests_integration_framework" description="Unit tests for integration testing framework">
        <exec dir="dev/tests/integration/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit_tests_integration_framework.xml"/>
        </exec>
    </target>
    <target name="_unit_tests_performance_framework" description="Unit tests for performance testing framework">
        <exec dir="dev/tests/performance/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit_tests_performance_framework.xml"/>
        </exec>
    </target>
    <target name="_unit_tests_static_framework" description="Unit tests for static code analysis framework">
        <exec dir="dev/tests/static/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit_tests_static_framework.xml"/>
        </exec>
    </target>
    <target name="_unit_tests_unit_framework" description="Unit tests for unit testing framework">
        <exec dir="dev/tests/unit/framework/tests/unit" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/unit_tests_unit_framework.xml"/>
        </exec>
    </target>
    <target name="_unit_tests_all" description="All unit tests">
        <antcall>
            <target name="_unit_tests_magento"/>
            <target name="_unit_tests_integration_framework"/>
            <target name="_unit_tests_performance_framework"/>
            <target name="_unit_tests_static_framework"/>
            <target name="_unit_tests_unit_framework"/>
        </antcall>
    </target>
    <target name="unit_tests_ee" description="Unit tests for EE">
        <antcall target="_unit_tests_all"/>
    </target>
    <target name="unit_tests_ce" description="Unit tests for CE">
        <antcall>
            <target name="_community_edition"/>
            <target name="_unit_tests_all"/>
        </antcall>
    </target>


    <target name="_static_tests_all" description="All static tests">
        <exec dir="dev/tests/static" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/static_tests_all.xml"/>
        </exec>
    </target>
    <target name="static_tests_ee" description="Static tests for EE">
        <antcall target="_static_tests_all"/>
    </target>
    <target name="static_tests_ce" description="Static tests for CE">
        <antcall>
            <target name="_community_edition"/>
            <target name="_static_tests_all"/>
        </antcall>
    </target>


    <target name="sanity_check_ce" depends="_community_edition" description="License replacement and sanity check for CE">
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/license/license-tool.php --
                -w ${basedir} -e ce -v"/>
        </exec>
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/sanity/sanity.php --
                -w ${basedir} -c ${basedir}/dev/build/publication/sanity/ce.xml -v"/>
        </exec>
    </target>


    <target name="_database_credential_substitution" description="Database credentials substitution in configuration file from environment variables">
        <fail unless="db_config_file" message="Property 'db_config_file' must be defined"/>
        <fail unless="env.db_host" message="Environment variable 'db_host' must be defined"/>
        <fail unless="env.db_name" message="Environment variable 'db_name' must be defined"/>
        <fail unless="env.db_user" message="Environment variable 'db_user' must be defined"/>
        <fail unless="env.db_password" message="Environment variable 'db_password' must be defined"/>
        <replace file="${db_config_file}">
            <replacefilter token="{{db_host}}" value="${env.db_host}"/>
            <replacefilter token="{{db_name}}" value="${env.db_name}"/>
            <replacefilter token="{{db_user}}" value="${env.db_user}"/>
            <replacefilter token="{{db_password}}" value="${env.db_password}"/>
        </replace>
    </target>


    <target name="_integration_tests_configuration" description="Generation of configuration for integration tests">
        <condition property="db_vendor_name" value="mysql">
            <not><isset property="db_vendor_name"/></not>
        </condition>
        <condition property="db_table_prefix" value="">
            <not><isset property="db_table_prefix"/></not>
        </condition>
        <condition property="developer_mode" value="enabled">
            <not><isset property="developer_mode"/></not>
        </condition>
        <copy file="${basedir}/dev/build/unified/core_dev/integration_tests/local-${db_vendor_name}.xml" todir="${basedir}/dev/tests/integration/etc" overwrite="true"/>
        <antcall target="_database_credential_substitution">
            <param name="db_config_file" value="${basedir}/dev/tests/integration/etc/local-${db_vendor_name}.xml"/>
        </antcall>
        <replace file="${basedir}/dev/tests/integration/etc/local-${db_vendor_name}.xml">
            <replacefilter token="{{db_table_prefix}}" value="${db_table_prefix}"/>
        </replace>
        <copy file="${basedir}/dev/build/unified/core_dev/integration_tests/phpunit.xml" todir="${basedir}/dev/tests/integration" overwrite="true"/>
        <replace file="${basedir}/dev/tests/integration/phpunit.xml">
            <replacefilter token="{{local_config_file}}" value="etc/local-${db_vendor_name}.xml"/>
            <replacefilter token="{{developer_mode}}" value="${developer_mode}"/>
        </replace>
    </target>


    <target name="_integration_tests_magento" description="Product integration tests">
        <exec dir="dev/tests/integration" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/integration_tests_magento.xml"/>
        </exec>
    </target>
    <target name="_integration_tests_magento_xdebug" description="Product integration tests with Xdebug">
        <chmod perm="u+x" file="${basedir}/dev/build/bin/phpunit-with-xdebug.sh"/>
        <exec dir="dev/tests/integration" executable="${basedir}/dev/build/bin/phpunit-with-xdebug.sh" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/integration_tests_magento_xdebug.xml"/>
        </exec>
    </target>
    <target name="integration_tests_ee_dev_mysql" description="Integration tests in dev mode on MySQL for EE">
        <antcall target="_integration_tests_configuration"/>
        <antcall target="_integration_tests_magento"/>
    </target>
    <target name="integration_tests_ee_mysql" description="Integration tests on MySQL for EE">
        <antcall target="_integration_tests_configuration">
            <param name="developer_mode" value="disabled"/>
        </antcall>
        <antcall target="_integration_tests_magento"/>
    </target>
    <target name="integration_tests_ee_dev_mysql_tpfx" description="Integration tests in dev mode with table prefix on MySQL for EE">
        <antcall target="_integration_tests_configuration">
            <param name="db_table_prefix" value="pfx_"/>
        </antcall>
        <antcall target="_integration_tests_magento"/>
    </target>
    <target name="integration_tests_ee_dev_xd_mysql" description="Integration tests in dev mode with Xdebug on MySQL for EE">
        <antcall target="_integration_tests_configuration"/>
        <antcall target="_integration_tests_magento_xdebug"/>
    </target>
    <target name="integration_tests_ee_xd_mysql" description="Integration tests with Xdebug on MySQL for EE">
        <antcall target="_integration_tests_configuration">
            <param name="developer_mode" value="disabled"/>
        </antcall>
        <antcall target="_integration_tests_magento_xdebug"/>
    </target>
    <target name="integration_tests_ee_dev_xd_mysql_tpfx" description="Integration tests in dev mode with Xdebug and table prefix on MySQL for EE">
        <antcall target="_integration_tests_configuration">
            <param name="db_table_prefix" value="pfx_"/>
        </antcall>
        <antcall target="_integration_tests_magento_xdebug"/>
    </target>
    <target name="integration_tests_ee_dev_xd_mssql" description="Integration tests in dev mode with Xdebug on MSSQL for EE">
        <antcall target="_integration_tests_configuration">
            <param name="db_vendor_name" value="mssql"/>
        </antcall>
        <antcall target="_integration_tests_magento_xdebug"/>
    </target>
    <target name="integration_tests_ee_dev_xd_oracle" description="Integration tests in dev mode with Xdebug on Oracle for EE">
        <antcall target="_integration_tests_configuration">
            <param name="db_vendor_name" value="oracle"/>
        </antcall>
        <antcall target="_integration_tests_magento_xdebug"/>
    </target>
    <target name="integration_tests_ce_dev_mysql" description="Integration tests in dev mode on MySQL for CE">
        <antcall target="_integration_tests_configuration"/>
        <antcall>
            <target name="_community_edition"/>
            <target name="_integration_tests_magento"/>
        </antcall>
    </target>
    <target name="integration_tests_ce_mysql" description="Integration tests on MySQL for CE">
        <antcall target="_integration_tests_configuration">
            <param name="developer_mode" value="disabled"/>
        </antcall>
        <antcall>
            <target name="_community_edition"/>
            <target name="_integration_tests_magento"/>
        </antcall>
    </target>
    <target name="integration_tests_ce_dev_mysql_tpfx" description="Integration tests in dev mode with table prefix on MySQL for CE">
        <antcall target="_integration_tests_configuration">
            <param name="db_table_prefix" value="pfx_"/>
        </antcall>
        <antcall>
            <target name="_community_edition"/>
            <target name="_integration_tests_magento"/>
        </antcall>
    </target>
    <target name="integration_tests_ce_dev_xd_mysql" description="Integration tests in dev mode with Xdebug on MySQL for CE">
        <antcall target="_integration_tests_configuration"/>
        <antcall>
            <target name="_community_edition"/>
            <target name="_integration_tests_magento_xdebug"/>
        </antcall>
    </target>
    <target name="integration_tests_ce_xd_mysql" description="Integration tests with Xdebug on MySQL for CE">
        <antcall target="_integration_tests_configuration">
            <param name="developer_mode" value="disabled"/>
        </antcall>
        <antcall>
            <target name="_community_edition"/>
            <target name="_integration_tests_magento_xdebug"/>
        </antcall>
    </target>


    <target name="_integration_integrity_tests_magento" description="Product integration integrity tests">
        <exec dir="dev/tests/integration" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/integration_integrity_tests_magento.xml testsuite/integrity"/>
        </exec>
    </target>
    <target name="integration_integrity_tests_ee_dev_mysql" description="Integration integrity tests in dev mode on MySQL for EE">
        <antcall target="_integration_tests_configuration"/>
        <antcall target="_integration_integrity_tests_magento"/>
    </target>
    <target name="integration_integrity_tests_ee_mysql" description="Integration integrity tests on MySQL for EE">
        <antcall target="_integration_tests_configuration">
            <param name="developer_mode" value="disabled"/>
        </antcall>
        <antcall target="_integration_integrity_tests_magento"/>
    </target>
    <target name="integration_integrity_tests_ce_dev_mysql" description="Integration integrity tests in dev mode on MySQL for CE">
        <antcall target="_integration_tests_configuration"/>
        <antcall>
            <target name="_community_edition"/>
            <target name="_integration_integrity_tests_magento"/>
        </antcall>
    </target>
    <target name="integration_integrity_tests_ce_mysql" description="Integration integrity tests on MySQL for CE">
        <antcall target="_integration_tests_configuration">
            <param name="developer_mode" value="disabled"/>
        </antcall>
        <antcall>
            <target name="_community_edition"/>
            <target name="_integration_integrity_tests_magento"/>
        </antcall>
    </target>


    <target name="_performance_tests_magento" description="Product performance tests">
        <chmod perm="a+w">
            <dirset dir="${basedir}/app/etc"/>
            <dirset dir="${basedir}/pub/media"/>
            <fileset dir="${basedir}/pub/media"/>
            <dirset dir="${basedir}/var"/>
        </chmod>
        <exec executable="php" failonerror="true">
            <arg value="${basedir}/dev/tests/performance/run_scenarios.php"/>
        </exec>
    </target>
    <target name="_performance_tests_configuration" description="Generation of configuration for product performance tests">
        <fail unless="env.web_access_host" message="Environment variable 'web_access_host' must be defined"/>
        <fail unless="env.web_access_path" message="Environment variable 'web_access_path' must be defined"/>
        <copy file="${basedir}/dev/build/unified/core_dev/performance_tests/config.xml" todir="${basedir}/dev/tests/performance" overwrite="true"/>
        <antcall target="_database_credential_substitution">
            <param name="db_config_file" value="${basedir}/dev/tests/performance/config.xml"/>
        </antcall>
        <replace file="${basedir}/dev/tests/performance/config.xml">
            <replacefilter token="{{web_access_host}}" value="${env.web_access_host}"/>
            <replacefilter token="{{web_access_path}}" value="${env.web_access_path}"/>
        </replace>
    </target>
    <target name="performance_tests_ce_mysql" description="Performance tests on MySQL for CE">
        <antcall>
            <target name="_community_edition"/>
            <target name="_performance_tests_configuration"/>
            <target name="_performance_tests_magento"/>
        </antcall>
    </target>

</project>
