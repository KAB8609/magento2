<?xml version="1.0" encoding="utf-8"?>
<!--
/**
 * Apache Ant's build file with general-purpose routines common to various CI builds
 *
 * {license_notice}
 *
 * @category   dev
 * @package    build
 * @copyright  {copyright}
 * @license    {license_link}
 */
-->
<project name="Core Development General-Purpose Routines" basedir="../../../" default="community_edition">
    <property environment="env"/>

    <target name="community_edition" description="Removal of files, which do not belong to the Community Edition">
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/extruder/extruder.php --
                -w ${basedir}
                -l ${basedir}/dev/build/publication/extruder/common.txt
                -l ${basedir}/dev/build/publication/extruder/ce.txt
                -v
                "/>
        </exec>
    </target>

    <target name="database_credential_substitution" description="Database credentials substitution in configuration file from environment variables">
        <fail unless="db_config_file" message="Property 'db_config_file' must be defined"/>
        <fail unless="env.db_host" message="Environment variable 'db_host' must be defined"/>
        <fail unless="env.db_name" message="Environment variable 'db_name' must be defined"/>
        <fail unless="env.db_user" message="Environment variable 'db_user' must be defined"/>
        <fail unless="env.db_password" message="Environment variable 'db_password' must be defined"/>
        <replace file="${db_config_file}">
            <replacefilter token="{{db_host}}" value="${env.db_host}"/>
            <replacefilter token="{{db_name}}" value="${env.db_name}"/>
            <replacefilter token="{{db_user}}" value="${env.db_user}"/>
            <replacefilter token="{{db_password}}" value="${env.db_password}"/>
        </replace>
    </target>

    <target name="installation_requirements" description="Environment setup for product installation">
        <chmod perm="a+w">
            <dirset dir="${basedir}/app/etc"/>
            <dirset dir="${basedir}/pub/media"/>
            <fileset dir="${basedir}/pub/media"/>
            <dirset dir="${basedir}/var"/>
        </chmod>
    </target>

</project>
