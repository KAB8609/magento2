#!/bin/bash
. ./include.sh

cd "./schemaspy"

MYSQL_DRIVER="./mysql-connector-java-5.1.6-bin.jar"
SCHEMASPY="./schemaSpy.jar"
OUTPUT=$3
METADATA_DB_NAME='schemaspy_md'

log "Creating metadata db..."
echo "DROP DATABASE IF EXISTS $METADATA_DB_NAME; CREATE DATABASE $METADATA_DB_NAME;" | mysql -h $DB_HOST -P $DB_PORT -u$DB_USER -p$DB_PASS
check_failure $?

rm -fr $OUTPUT
mkdir "$OUTPUT"
mkdir "$OUTPUT/tmp"

php -f generator.php -- $DB_HOST $DB_USER $DB_PASS $CHECKOUT $DB_NAME $METADATA_DB_NAME $DB_PREFIX

cat > "$OUTPUT/tmp/schema_builder.sql" <<DELIM
SET group_concat_max_len = 4096;
SELECT CONCAT(
'java -jar $SCHEMASPY -t mysql -host $DB_HOST -db $DB_NAME -u $DB_USER -p $DB_PASS -o $OUTPUT/magento/', module_name,
' -dp $MYSQL_DRIVER -norows -lq -i "', REPLACE(GROUP_CONCAT('(',table_name,')'),',','|'), '|(nothing)', '"', ' -desc "', module_name, '"') AS "#!/bin/bash"
FROM vw_modules_tables
WHERE code_group in  (1)           
GROUP BY module_name;
DELIM

mysql -h $DB_HOST -P $DB_PORT -u$DB_USER -p$DB_PASS $METADATA_DB_NAME < modules_list.sql > "$OUTPUT/tmp/list.html"

mysql -h $DB_HOST -P $DB_PORT -u$DB_USER -p$DB_PASS $METADATA_DB_NAME < "$OUTPUT/tmp/schema_builder.sql" > "$OUTPUT/tmp/schema_builder"

chmod +rx "$OUTPUT/tmp/schema_builder"

java -jar ./schemaSpy.jar -t mysql -host $DB_HOST -db $DB_NAME -u $DB_USER -p $DB_PASS -o "$OUTPUT/magento/All" -dp $MYSQL_DRIVER -norows -lq -desc "Magento DB Schema"

sh $OUTPUT/tmp/schema_builder

cp index.html "$OUTPUT/tmp/list.html" $OUTPUT
