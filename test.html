<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en">
<head>
    <title>Magento Admin</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf8" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="skins/admin/styles.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" media="all" href="js/extjs/resources/css/ext-all.css"/>
    <link rel="stylesheet" type="text/css" media="all" href="js/extjs/resources/css/ytheme-default.css" id="theme_stylesheet"/>
</head>

<body>
    <script type="text/javascript" language="Javascript">
        var BASE_URL = 'admin/';
        var SKIN_URL = 'admin/';
    </script>
    <script language="javascript" type="text/javascript" src="js/extjs/adapter/yui/yui-utilities.js" ></script>
    <script language="javascript" type="text/javascript" src="js/extjs/adapter/yui/ext-yui-adapter.js" ></script>

    <script language="javascript" type="text/javascript" src="js/extjs/ext-all.js" ></script>
    <script type="text/javascript" language="Javascript">
        Ext.BLANK_IMAGE_URL = 'js/extjs/resources/images/default/s.gif';
        Ext.UpdateManager.defaults.loadScripts = false;
        Ext.UpdateManager.defaults.disableCaching = true;
    </script>
    <script>
    var productGrid = null;
    
	Catalog_Category_Tree = function(){
    var tree = null;
    var categoryContextMenu = null;

    return{
        loadChildrenUrl: 'admin/category/treeChildren/',
        moveNodeUrl: 'admin/category/move/',
        removeNodeUrl: 'admin/category/remove/',
        loadWebsiteUrl: 'admin/category/treeWebsite/',
        websiteListUrl : 'admin/website/list/',
        tree: null,
        websiteId: null,
        btns : null,

        create: function(){
            if (!this.tree) {
                Ext.QuickTips.init();
                
                var ds = new Ext.data.Store({
                    proxy: new Ext.data.HttpProxy({
                        url: this.websiteListUrl
                    }),
                    reader: new Ext.data.JsonReader({id: 'value'}, [
                        {name: 'value', mapping: 'value'},
                        {name: 'text', mapping: 'text'}
                    ])
                });
                
                categoryContextMenu = new Ext.menu.Menu({
                        id : 'category_context_menu',
                        items: [{text: 'Show Category Products', handler: this.showProducts.createDelegate(this)},
                                '-',
                                {text: 'Add child',handler:this.onAddCategory.createDelegate(this)},
                                {text: 'Edit Catecory',handler:this.onEditCategory.createDelegate(this)},
                                {text: 'Delete Category',handler:this.deleteCategoryConfirm.createDelegate(this)}]
                });

                this.tree = new Ext.tree.TreePanel('tree', {
                    animate:true, 
                    loader: new Ext.tree.TreeLoader({dataUrl:this.loadWebsiteUrl}),
                    enableDD:true,
                    containerScroll: true,
                    rootVisible:false
                });
                
                var sm = this.tree.getSelectionModel();
                
                this.tree.addListener('contextmenu',this.categoryRightClick,this);
                this.tree.addListener('click',this.categoryClick.createDelegate(this));
                this.tree.addListener('dblclick',this.categoryDblClick,this);
                this.tree.addListener('beforenodedrop', this.moveNode, this);

                var root = new Ext.tree.AsyncTreeNode({
                    text: 'root', 
                    draggable:false,
                    expanded:false
                });
                this.tree.setRootNode(root);
                this.tree.render();
                this.loadWebsiteRoot();
            }
        },

        onAddCategory : function(btn, event) {
            var sm = this.tree.getSelectionModel();
        },

        onEditCategory : function(btn, event) {
            var sm = this.tree.getSelectionModel();
        },


        setWebsite: function(select, record){
            this.loadWebsiteRoot(record.id);
            this.websiteId = record.id;
        },

        loadWebsiteRoot: function(websiteId){
            this.tree.loader.dataUrl = this.loadWebsiteUrl;
            this.tree.loader.baseParams.website = websiteId;
            this.tree.root.reload();
            this.tree.loader.dataUrl = this.loadChildrenUrl;
        },

        addChildDialog: function(){
        
        },

        moveNode: function(obj){
            var data = {
                id: obj.dropNode.id
            }
            
            data.point = obj.point;
            switch (obj.point) {
                case 'above' :
                    data.pid = obj.target.parentNode.id;
                    if (obj.target.previousSibling) {
                        data.aid = obj.target.previousSibling.id;
                    } else {
                        data.aid = 0;
                    }
                    break;
                case 'below' :
                    data.pid = obj.target.parentNode.id;
                    data.aid = obj.target.id;
                break;
                case 'append' :
                    data.pid = obj.target.id;
                    if (obj.target.lastChild) {
                        data.aid = obj.target.lastChild.id;
                    } else {
                        data.aid = 0;
                    }
                break;
                default :
                    obj.cancel = true;
                    return obj;
            }

            var success = function(o) {
                try { eval(o.responseText); } catch(e) { Ext.dump(e); }
            };
            var failure = function(o) {
                Ext.dump(o.statusText);
            };

            var pd = [];
            for(var key in data) {
                pd.push(encodeURIComponent(key), "=", encodeURIComponent(data[key]), "&");
            }
            pd.splice(pd.length-1,1);
            var con = new Ext.lib.Ajax.request('POST', this.moveNodeUrl, {success:success,failure:failure, scope:obj}, pd.join(""));
        },

        editNodeDialog: function(){
        
        },
        
        deleteCategoryConfirm: function(item, event){
            Ext.MessageBox.confirm('Tree Message', 'Are you sure ?', this.deleteCategory, this);
        },

        deleteCategory: function(flag){
            if (flag == 'yes') {
                var node = this.tree.getSelectionModel().getSelectedNode();
                var success = function(o) { this.parentNode.removeChild(this);};
                var failure = function(o) { Ext.dump(o.statusText); };
                var con = new Ext.lib.Ajax.request('GET', this.removeNodeUrl+'id/'+node.id+'/', {success:success,failure:failure,scope:node});
            }
        },

        categoryRightClick: function(node, event){
            categoryContextMenu.selectedNode = node;
            node.select();
            categoryContextMenu.showAt(event.getXY(),categoryContextMenu.parentMenu,false);
        },

        categoryDblClick: function(){
            
        },
        
        categoryClick: function(node, e){
            if (categoryContextMenu){
                categoryContextMenu.hide();
            }
            this.showProducts(null, e, node);
        },
            
        //////////////// Context menu handlers /////////////
        showProducts: function(item, event, selectedNode) {
            if (selectedNode) {
                productGrid.getDataSource().proxy.getConnection().url = 'admin/product/gridData/category/' + selectedNode.id + '/';
            } else {
                productGrid.getDataSource().proxy.getConnection().url = 'admin/product/gridData/category/' + item.parentMenu.selectedNode.id + '/';
            }
            productGrid.getDataSource().load();
        },

        addChild: function(item, event) {
            //addChildDialog(item);
        },

        editCategory: function(item,event){
            alert('edit category');
        }
    }
}();    
    
		function initGrid(catId) {
            var dataRecord = Ext.data.Record.create([
                {name: 'id', mapping: 'product_id'},
                {name: 'name', mapping: 'name'},
                {name: 'price', mapping: 'price'},
                {name: 'description', mapping: 'description'}
            ]);

            var dataReader = new Ext.data.JsonReader({
                root: 'items',
                totalProperty: 'totalRecords',
                id: 'product_id'
            }, dataRecord);

             var dataStore = new Ext.data.Store({
                proxy: new Ext.data.HttpProxy({url: 'admin/product/gridData/category/' + catId + '/'}),
                reader: dataReader,
                remoteSort: true
             });

            dataStore.setDefaultSort('product_id', 'desc');


            var colModel = new Ext.grid.ColumnModel([
                {header: "ID#", filter : 'numeric', sortable: true, locked:false, dataIndex: 'id'},
                {header: "Name", filter : 'string', sortable: true, dataIndex: 'name'},
                {header: "Price", filter : 'numeric', sortable: true, renderer: Ext.util.Format.usMoney, dataIndex: 'price'},
                {header: "Description", filter : 'string', sortable: false, dataIndex: 'description'}
            ]);

            productGrid = new Ext.grid.Grid('grid', {
                ds: dataStore,
                cm: colModel,
                autoSizeColumns : true,
                loadMask: true,
                enableDragDrop : true,
                monitorWindowResize : true,
                autoHeight : false,
                selModel : new Ext.grid.RowSelectionModel({singleSelect : true}),
                enableColLock : false
            });

            productGrid.render();

            var gridHead = productGrid.getView().getHeaderPanel(true);
            var gridFoot = productGrid.getView().getFooterPanel(true);

            var paging = new Ext.PagingToolbar(gridHead, dataStore, {
                pageSize: 25,
                displayInfo: true,
                displayMsg: 'Displaying products {0} - {1} of {2}',
                emptyMsg: 'No products to display'
            });

            var btnAdd = new Ext.Toolbar.Button({
                text: 'Filter',
                cls: 'x-btn-text-icon btn-add',
                disabled : true
             });
            paging.insertButton(0, btnAdd);

            var btnApply = new Ext.Toolbar.Button({
                text: 'Apply',
                cls: 'x-btn-text-icon btn-accept',
                disabled : true
             });
             paging.insertButton(1, btnApply);            
             
             var bntReset = new Ext.Toolbar.Button({
                text: 'Reset',
                cls: 'x-btn-text-icon btn-delete',
                disabled : true
             });
             paging.insertButton(2, bntReset);            
             
             paging.insertButton(3, {
                text: 'Product',
                handler : function(){
                	window.open('index.php', 'test', 'width=640, height=380');
                },
                cls: 'x-btn-text-icon btn-package-add'
             });
            
            paging.insertButton(4, new Ext.Toolbar.Separator());
        }
        
        Ext.onReady(initGrid);
        Ext.onReady(Catalog_Category_Tree.create, Catalog_Category_Tree, true);
    
    </script>
<div>
<div id="tree" style="float : left"></div>
<div id="grid" style="float : left; width : 1200"></div>
</div>
</body>
</html>